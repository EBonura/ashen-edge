<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ashen Edge Level Editor</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #1d2b53; color: #fff; font-family: monospace; display: flex; height: 100vh; overflow: hidden; user-select: none; }
#sidebar { width: 400px; background: #111; display: flex; flex-direction: column; border-right: 2px solid #333; flex-shrink: 0; }
#sidebar h2 { padding: 8px; font-size: 13px; background: #222; text-align: center; display: flex; justify-content: center; align-items: center; gap: 8px; }
#sidebar h2 button { background: #444; color: #fff; border: 1px solid #666; cursor: pointer; font-size: 14px; width: 22px; height: 22px; line-height: 1; padding: 0; font-family: monospace; }
#sidebar h2 button:hover { background: #555; }
#palette { flex: 1; overflow-y: auto; padding: 4px; }
.tile-group { margin-bottom: 8px; }
.tile-group-label { font-size: 11px; color: #aaa; padding: 2px 4px; }
.tile-grid { display: grid; gap: 1px; padding: 2px; }
.tile-btn { width: 40px; height: 40px; border: 2px solid transparent; cursor: pointer; position: relative; image-rendering: pixelated; background-color: #1a1a2a; }
.tile-spacer { width: 40px; height: 40px; }
.tile-btn.selected { border-color: #ff004d; }
.tile-btn canvas { width: 100%; height: 100%; image-rendering: pixelated; }
.tile-flag { position: absolute; bottom: 0; right: 0; font-size: 8px; background: rgba(0,0,0,0.7); color: #ff0; padding: 0 2px; pointer-events: none; }
#flag-editor { padding: 8px; background: #1a1a1a; border-top: 1px solid #333; }
#flag-editor label { font-size: 11px; }
#flag-buttons { display: flex; gap: 3px; margin-top: 4px; }
#flag-buttons button { width: 24px; height: 24px; font-size: 12px; cursor: pointer; border: 1px solid #555; background: #333; color: #fff; }
#flag-buttons button.active { background: #ff004d; border-color: #ff004d; }
#spawn-info { padding: 4px 8px; font-size: 11px; color: #0f0; background: #1a1a1a; border-top: 1px solid #333; }
#toolbar { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #222; border-bottom: 1px solid #333; font-size: 12px; flex-wrap: wrap; }
#toolbar button { padding: 4px 10px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; font-family: monospace; font-size: 11px; }
#toolbar button.active { background: #ff004d; border-color: #ff004d; }
#toolbar button:hover { background: #444; }
#toolbar input[type=number] { width: 50px; background: #333; color: #fff; border: 1px solid #555; padding: 2px 4px; font-family: monospace; }
#toolbar label { color: #aaa; }
#toolbar .sep { width: 1px; height: 20px; background: #444; }
#main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
#canvas-wrap { flex: 1; overflow: hidden; position: relative; cursor: crosshair; }
#map-canvas { position: absolute; top: 0; left: 0; image-rendering: pixelated; }
#status { padding: 4px 12px; background: #111; font-size: 11px; color: #aaa; border-top: 1px solid #333; display: flex; gap: 16px; }
#export-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
#export-modal.show { display: flex; }
#export-content { background: #222; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
#export-content h3 { margin-bottom: 10px; }
#export-content textarea { width: 100%; height: 200px; background: #111; color: #0f0; border: 1px solid #555; font-family: monospace; font-size: 11px; padding: 8px; }
#export-content button { margin-top: 8px; padding: 6px 16px; background: #ff004d; color: #fff; border: none; cursor: pointer; font-family: monospace; }
#band-editor { padding: 6px; background: #1a1a1a; border-top: 1px solid #333; }
#band-editor h3 { font-size: 11px; color: #aaa; margin-bottom: 4px; }
.band-row { display: flex; align-items: center; gap: 4px; margin-bottom: 3px; }
.band-label { font-size: 10px; color: #888; width: 52px; text-align: right; flex-shrink: 0; }
.band-preview { width: 16px; height: 16px; border: 1px solid #444; flex-shrink: 0; }
.band-colors { display: flex; gap: 1px; flex-wrap: wrap; }
.band-swatch { width: 16px; height: 16px; cursor: pointer; border: 2px solid transparent; }
.band-swatch:hover { border-color: #fff; }
.band-swatch.active { border-color: #ff004d; }
#toast { position:fixed; top:12px; left:50%; transform:translateX(-50%); background:#ff004d; color:#fff; padding:6px 16px; border-radius:4px; font-size:12px; opacity:0; transition:opacity 0.2s; pointer-events:none; z-index:200; }
#toast.show { opacity:1; }
.pal-tab { background: #333; color: #aaa; border: 1px solid #555; cursor: pointer; padding: 6px 14px; font-size: 14px; font-family: monospace; }
.pal-tab.active { background: #ff004d; color: #fff; border-color: #ff004d; }
.pal-tab:hover { background: #444; }
#pal-zoom-in, #pal-zoom-out { background: #333; color: #aaa; border: 1px solid #555; cursor: pointer; padding: 6px 12px; font-size: 14px; font-family: monospace; }
#pal-zoom-in:hover, #pal-zoom-out:hover { background: #444; }
.layer-btn { min-width: 40px; }
.layer-eye { font-size: 14px; padding: 2px 6px !important; min-width: 28px; opacity: 1; }
.layer-eye.hidden { opacity: 0.3; }
.parallax-input { width: 45px; background: #333; color: #fff; border: 1px solid #555; padding: 2px 4px; font-family: monospace; font-size: 11px; }
</style>
</head>
<body>

<div id="sidebar">
  <h2><button id="pal-zoom-out">-</button> <button class="pal-tab active" data-tab="main">Tiles</button><button class="pal-tab" data-tab="bg">BG</button> <button id="pal-zoom-in">+</button></h2>
  <div id="palette"></div>
  <div id="band-editor">
    <h3>Color Remap</h3>
    <div id="band-rows"></div>
  </div>
  <div id="flag-editor">
    <label>Flags for <span id="flag-tile-name">-</span>:</label>
    <div id="flag-buttons"></div>
  </div>
  <div id="spawn-info">Spawn: not set</div>
</div>

<div id="main">
  <div id="toolbar">
    <button id="tool-pencil" class="active" title="Pencil (B)">&#9998; Pencil</button>
    <button id="tool-rect" title="Rectangle (T)">&#9634; Rect</button>
    <button id="tool-fill" title="Flood Fill (G)">&#9681; Fill</button>
    <button id="tool-eraser" title="Eraser (E)">&#9003; Eraser</button>
    <button id="tool-spawn" title="Spawn Point (P)">&#9679; Spawn</button>
    <button id="tool-select" title="Select (S)">&#9744; Select</button>
    <div class="sep"></div>
    <button id="mode-random" title="Random tile from selection" style="opacity:0.4">Random</button>
    <button id="mode-stamp" title="Stamp pattern from selection" style="opacity:0.4">Stamp</button>
    <div class="sep"></div>
    <label>W:</label><input type="number" id="map-w" value="128" min="1" max="1024">
    <label>H:</label><input type="number" id="map-h" value="32" min="1" max="512">
    <button id="btn-resize">Resize</button>
    <div class="sep"></div>
    <button id="btn-grid" title="Toggle Grid (Tab)">Grid: ON</button>
    <button id="btn-flags-overlay" title="Toggle flag overlay (F)">Flags: OFF</button>
    <div class="sep"></div>
    <button id="btn-save" title="âŒ˜S">Save</button>
    <div class="sep"></div>
    <button class="layer-btn" data-layer="0" title="Background (1)">BG</button>
    <button class="layer-btn active" data-layer="1" title="Main layer (2)">Main</button>
    <button class="layer-eye" data-layer="0" title="Toggle BG visibility">&#128065;</button>
    <button class="layer-eye" data-layer="1" title="Toggle Main visibility">&#128065;</button>
    <label>Parallax:</label>
    <label style="font-size:10px">BG</label><input type="number" class="parallax-input" data-layer="0" value="0.5" step="0.05" min="0" max="2" title="BG scroll speed">
    <button id="btn-load" title="Ctrl+O">Load JSON</button>
    <button id="btn-export" title="Ctrl+E">Export</button>
    <span id="st-cart" style="color:#7e7;font-size:11px;"></span>
    <div class="sep"></div>
    <button id="btn-undo" title="Ctrl+Z">Undo</button>
    <button id="btn-redo" title="Ctrl+Shift+Z">Redo</button>
    <div class="sep"></div>
    <button id="btn-clear" style="background:#a00">Clear All</button>
  </div>
  <div id="canvas-wrap">
    <canvas id="map-canvas"></canvas>
  </div>
  <div id="status">
    <span id="st-pos">-</span>
    <span id="st-tile">-</span>
    <span id="st-zoom">Zoom: 1.5x</span>
    <span id="st-size">-</span>
    <span id="st-xform">Xform: none</span>
    <span id="st-mode">Mode: single</span>
    <span id="st-mem" style="color:#7e7">-</span>
  </div>
</div>

<div id="export-modal">
  <div id="export-content">
    <h3>Export Compressed Map</h3>
    <p id="export-info" style="margin-bottom:8px;font-size:12px;color:#aaa;"></p>
    <textarea id="export-hex" readonly></textarea>
    <button id="export-copy">Copy to Clipboard</button>
    <button id="export-close" style="background:#555;margin-left:8px;">Close</button>
  </div>
</div>

<input type="file" id="file-input" accept=".json" style="display:none">

<script>
const TILES = [{"name":"T_00_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQElEQVR4nGPk5ub+z0ABYKJE83A1gJ2dnTIDfv78yeDp6YmhEJfBjLii0dPTk2Hfvn0oBpNkALFgEMbCqAGkAwA93g1uo/LIoQAAAABJRU5ErkJggg=="},{"name":"T_00_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKklEQVR4nGNgwAO4ubn/45PHC2CaCRnCRLYNpLiCIs2jXqAQjHphqHgBACVaEgt0HFHvAAAAAElFTkSuQmCC"},{"name":"T_00_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAVUlEQVR4nGPk5ub+z0ABYKJE86gBowYwMDAwsLOzD6AL2NnZyTcAphnDAGQJYjQ7OTkxsKALohnCiMRGybVOTk4MDAwMDCzs7Oy4FCGLw/j/oZrhcgCOWwdAhDQhfAAAAABJRU5ErkJggg=="},{"name":"T_00_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAApklEQVR4nKWRsQ0DIQxFv1EkF3QeiRkYkxkYiZ6KNGfEOSaX3FmiwX6PD1CMceBBhSfwpYCZ7wsUvpK4Agsx81b0ITCDtCxX8lrB3vtspJTIzFKtdahEZynGOBYzHbAbFwBqradvD//AXl+vYOPqaVtwJvh6nC+jQ0YAiERkOA+GUgoAQERO+zZJ8KIpDACttblsT69AO9iWJ6Gc80/wruYj3oEB4A16aTbHL7TKIwAAAABJRU5ErkJggg=="},{"name":"T_00_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAeElEQVR4nO2TMQ7AIAhFPy4Obh7JM3hMz8YV2oU2qEhMXDqURT/CyydESildOIhw0vwDPgOIMXYJrce3pYOnUJ9jzgOQFJLcac+8AEopMJo67bkIACAQN1aQdwsGZBrFgnRrZGYw8whxxyEAqLWitTbRc85amt/+BvTtDnTOOYmKAAAAAElFTkSuQmCC"},{"name":"T_00_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAa0lEQVR4nO2TOw6AMAxDHYSUoVuPlIP7amUKCpBSPgMLnqIoz/FiKaU0vND0Bv4NvjJQVajqM4MI+jzfBff7YYIe7OomGIGuNMFVOE2QwWYmPpPclE9iGyNsZutN9pkkADSptR7qHD+eiSQWoJEPgRfirKAAAAAASUVORK5CYII="},{"name":"T_00_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZ0lEQVR4nO2TMQrAMAhFv6Hg4OaRPHjulclOBinYDG6lfwkheQ8dPomIo5HRgX/BdwTM3J+gI9krZEklZOb9FiepatmFtdZReuWLmQEAAcCcM6DXspGqegaLeEifGWZGBzjklP5u5gZzcxDmR/05MwAAAABJRU5ErkJggg=="},{"name":"T_00_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVR4nGPk5ub+z0ABYKJE86gBowaMGkBNA9jZ2Rk8PT0Z2NnZGRgYGOA0IQBTBwATsgJvh2LS8wAAAABJRU5ErkJggg=="},{"name":"T_00_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKElEQVR4nGPk5ub+z0ABYKJE86gBowaMGoAALORqZGdnJ90AmCZkAADcCwFuj03jqAAAAABJRU5ErkJggg=="},{"name":"T_00_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASUlEQVR4nGPk5ub+z0ABYKJE86gBOAxgZ2enzICfP38yeHp6YijEZTAjrnTg6enJsG/fPhSDSTKAWDAIY2EYGcDExATHyGLoAAAo6w2GY5et8AAAAABJRU5ErkJggg=="},{"name":"T_01_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAd0lEQVR4nO2QIQ7AIAxFPxhEHUfiDByTsxEMogamWAisbGRmYj+poElfXwH+fCBEVN/Mqx5gjEGMUe0AdP9gZnjv94yIqPZlra07kOmEFuccACCEsDxJjZ/YIKWUs5dSEiF6bDDznfXaQErO+dJiMpAiLXoMkCAHWYEl7qlWqSsAAAAASUVORK5CYII="},{"name":"T_01_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAHUlEQVR4nGNUVlb+z0ABYKJE86gBowaMGjCYDAAA9w0BiPL2oWwAAAAASUVORK5CYII="},{"name":"T_01_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAh0lEQVR4nGNgGAWjgAqAkZCCgwcPcsDY9vb2P0gyAKpZkIGBgYOBgeEHAwPDe3RDmIjQLMnDw3MPaggGwGkAFHDw8PCcTU1NZYC6AAOwEDDgx5cvX5Tevn17Lygo6Nnbt28JhhkKOHjwIIewsPB/YWHh/7y8vP+xqcFrIjc3N4qmr1+/YqgHAGuDJsvdXF7eAAAAAElFTkSuQmCC"},{"name":"T_01_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4nO2QsQ3DMAwEz0EKFWRhqIqX0TRaTztoAK+QFVyoEdTIjW0IiOEoQEp/RRL/j+fDjRt/wNBDijGafXbO5Z8MNvEIGCADS2vy6ExqROQNvICxTdRrkL33iMi8JTnQ1YG1toYQJk7eeH4Tq2otpQAs+63t4DKBqtZ2Tyl98Fea/yJk/KQnVgAAAABJRU5ErkJggg=="},{"name":"T_01_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAXUlEQVR4nGNgGAWjYFgARnySBw8e5ICx7e3tf5BkAFSzIAMDAwcDA8MPBgaG99gMYSLgQg5OTs57UEOwArwGxMXF3fv+/bsS1AVYAU4v8PLy/mdjY4Pz3759i1UtABboFQhcjA8+AAAAAElFTkSuQmCC"},{"name":"T_01_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABQUlEQVR4nNWSMW7DIBSGP6oO9kBE2HKFrhk7+DQ5QqaMOYBPkKNkYOjoQ3hqFjsoWLIhg7vg1HZiqWuREOLB/73/PYB/P8TSgTEmAZK47bIs6/4MiOI1oGLIAtdXkPcFA0kUb5RSZ2vtFkiMMR3Qjh29LZUAoJQ67/d7jsdjAWxGcx1dTgHGmMQYo6J9rLXbw+Hweb/f0Vp/aa0HkIoufwGjujdxTQe73nvKsgRAa32OZ+ncwaNurXWhlCoAdrtd4b0nz3PKsqSqKiK4nTcxBdKYgdvtNsRwzgEgpdxGoQW6OaAF2qqqaJqGPM+p67pomoYQAqfTaVLW8ApjQAdYIcSHlDKt67pwzhFCIIRAlmU2Zp6MRw8i8Qp8A9+XywVrLd57AFarVT8Xw8JPlFL2Qgj6fqpxzj3dfwpIKV9mWgL9AN1fk4I4BRW8AAAAAElFTkSuQmCC"},{"name":"T_01_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABHUlEQVR4nNWSsWrDMBCGP5fGSAWDY0OhHTzlPfwafoy8iR/CEJLdGTv4AbJ2coZgyBZS8KAgMNehtlFL4mTtwQ2S7v+k/07w78ObOqyqSgEK0IABLmmaXh4C9OI5EDqAL+DsQp4mHqB68VsURbswDD/7tXKLpgAa0FEUfQA0TTPuPQowgDmdThwOB/I8BzBZlh3dors9WC6XR9/3sdbSti11Xf/S3AQEQSC+7zOkiFAUxQtg0zTthrrnCQtYa+m6DhFhs9m88uNfgBEw+Q+CIBCAsiznSqmz53kYY95xRnmziYMYIMuy836/ZzabobU+8meUV8VuxnEsi8VCVquVbLdbSZJkhF+14N4+xNBMgPV6rQcL3j3hrWjb1gP4BpMEaneF4UPyAAAAAElFTkSuQmCC"},{"name":"T_01_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABY0lEQVR4nI2TP27CMBSHPyxkhcFKDBMTQ7auHTv4AlyGhZEDcA9u0AtwANZuHhADm+PISCArCh1IUwh/2p9kybL9+97ze3aPB1qv1wmQAAPgCJyMMadHZ3tPzBrIrgHNoAvsPTGPsyzbCCGw1qK1/ugAPFAYY05dQNaYv4QQ7fp2u23nVVWhtX4H9kAhuNUAGFybvfcApGlKmqbkeU5RFJvmikkXcASO1to7M0CWZQDkef4brAM4AV5r/W6tpSzLduPHDFDXdRvsZRdms9lXv98nSRLm8zmTyYS6rvHeP60BTXsKYB9CoKoqAJRSU+fc1Hv/0ezfd6Gr8Xh8Ho1GrFYrhBA456ZN5L0xZg9wl8G1pJRIKdntdnjvGQ6Hn90zLwExRmKMLJdLyrK8Kd6fAKXUOcZICAHnHIvFAu/9G5dX2P6L/l8ZHA4HYoxIKeFy/5uP9bCISqnzM2gI4cbzsgb/0TcibKS4IXpmigAAAABJRU5ErkJggg=="},{"name":"T_01_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABJklEQVR4nO2QMWrDMBiFPwUj1E0mU7qFbF57AA+9gU8Q8AVMtlwiN8gBsvgOuoTHrtmiHxyI8JB0qFRUl6yd+kBIeuK9/+kpIpxzBjAATdP4aZp4hnEcVTovMnEJrIBV3/evWuunBjmKuBvAWmsHABGptNbMU2it6fu+BCwQ6roOi7mj956u64Y5r7WmLEu6rvMxaemcMylBAGS73aY/fk8fx1E550zbtrflcsl+v+fxeAxKqQq4qVkHpm3bj+v1yjRNXC6X9G6Blfd+2Gw23O93RKQCzotMbGMXnE6nlyTOsV6vk/gNECAUeYG73Y7j8VhFLmTa8NWtVPEugP9Rooi8Hw6H+VAA6roOgAfOcfnIUST3aFKlaE9MfvF5iSbFTe7/+CN8AmuejZCtdKFnAAAAAElFTkSuQmCC"},{"name":"T_01_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABSElEQVR4nN2SMY7CMBBFn6NAQmHJhmqr9LQpKSj2BlyAM3AIenrOsgXFlrS5AhXOiCBAAuEt1taGwGr7/ZIlW555M/NtRUtaa88fappGtc+qG6C19kopvH9kdROj0rjZbDY5kAN2NpvV1+sV7z1Kvcx7BIRkCxgAay3H45HT6QTA4XD4lRI7yAHjva9EhNFoBMDtdovdGWAAnIHLdDq9RIBqBbwZY6okSdjv9yilxvP5vErTFK01q9WqDAAB6ghJAugCiIiU9/sday0A/X4frTXD4ZCmabbe+yqMmccOEoBAq4GdiIxFpARYr9dllmUsFguKooijDcL6AXQgElodAHmWZRRFAYBz7j3cnZ8ALcgZwBizXS6Xn71eD+fcxDlXArtQ4NHEtqKhwdSPME4dkp5eIe0CoqF8uzqm43pXLz9I61fSrfgP9QWliY+EdPM0XAAAAABJRU5ErkJggg=="},{"name":"T_02_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYklEQVR4nO2TSQrAMAgAx1LwkF/5cL+WXmIpJhTS9FKo4ElmXEAppVQWYluBfwGo6tdXeEWwzwKq+nyCBkvLecEVBMTMkLtnyuMmAZBuMACiUwXE3bviKQjYzLpO7i5Ry5IDvPANsXvXSmkAAAAASUVORK5CYII="},{"name":"T_02_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVR4nN2RMQrAMAwD5Swa/Ctt+bT/5aldSpZCCXEgUG0afJywufuFQlrleA+A5GGDHwAy87DBljeSxCqoPkHSKCsmLSJMkgEwACbJeu/TsNeEiMADGlZfuQHTQQ1Vca7wCwAAAABJRU5ErkJggg=="},{"name":"T_02_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATUlEQVR4nGPk5ub+z0ABYKJE88AZwM7OPoAuYGdnZ/j58yeNXYDsR2Tg6emJYjsDAwMDCzaFP3/+hBvi5OQEF9++fTuGWsYRmpCGmQEALWkPPMR94FAAAAAASUVORK5CYII="},{"name":"T_02_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAVUlEQVR4nO2TsRGAMAwDZRoV2eq77JoZvBo0mAPuqFISV7ItvStHa23XRG0z4QVYgD8CbMu2eu+X/gTUsoxnH0CMMQIQINuK9ztXGLiPQ5Iy83EI0AGN7wwss/6j8AAAAABJRU5ErkJggg=="},{"name":"T_02_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAmklEQVR4nMWPsQ7FIAhFL00TBjc+ie/1G/wkNgenvqUaNLXRdHgsBsM9HCiEcOFDHV/CWwBm/rPBzGIZUErpIPXdMhghS4BRu0KWATNgBU0BfjMzd723ON+CrgjAxcx7J9wwchDKOZM3egWoKsys9WYGEYGZUV1wjLf6cIyRHK+GISLt73xQhaoipdQNepO7JxEB+aFB8+26Vj/tujaVf5QTyAAAAABJRU5ErkJggg=="},{"name":"T_02_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAVElEQVR4nO2SMQoAMQgEVznYwpf5/9fYmLQhXHFKIM1NKeywqGJmAwuqiszEV3QfVMKvgiotAclzDZ5OKCLg7gAA2a9Q5c4Sf8FpwfqW3QZCEl3RBM2uDHYeCpf+AAAAAElFTkSuQmCC"},{"name":"T_02_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdUlEQVR4nM1SOQrAMAyTSkFDfuUte56ZN+RJ2TO1UyCEllIHSg1eDDqQzBDCgYXZVsA/JZDkJ5CE1to7ghgjJLnAAEBPjaOYO8Se1fc1zi0tOZD0jmBWNzPsHuAwvHXQf2MAs2+tlWbGUsqjA14dU0rIOQMATrLRFqekJz6jAAAAAElFTkSuQmCC"},{"name":"T_02_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAkklEQVR4nO2TMQ4DIQwEd2m2oPOT/F7ewJPcuyLNHbpLkHISTYpYQjYCz64Ls9Y6sBFlp/kP+HmApH0HTyBLwFP1JUAS3B3uzm9ASaCZjcyEJJwZAC//bruSmTdAcfepIAkRwYjAeQ4YATAiKImSZg/NDO5+qrC19mHVzBARMLP3p1EAoPdOAOy9L2c9nMz6cucLZP8yr7lUTbQAAAAASUVORK5CYII="},{"name":"T_02_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANUlEQVR4nGPk5ub+z0ABYKJE86gBowYMNwPY2dnJN4ASzQwMDAwsDAwMjEiu+P/z50+SDAAArFQFbEmiuC4AAAAASUVORK5CYII="},{"name":"T_02_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAL0lEQVR4nGPk5ub+z0ABYKJE86gBowYMIwNYyNHEzs5OngHIGqGAkWgD0DQzwhgA6r0Bh1mZI8YAAAAASUVORK5CYII="},{"name":"T_02_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgUlEQVR4nO2QOwrEMAxERyGgwt0cyWfQeX2k6V15m3WwQ36QamEFAsszb4RtKaWGF7W8gf8BPxHg7nD3S329Eo/OtdZpXs+gJ8HA8IQn8EHZMsI5ZwCws/7q3WsAYCTbDkYpZVojCRExXrXuBcmtI2KaSU5Bo94DbW+StIGSbj/hA2LVGy6gK3zVAAAAAElFTkSuQmCC"},{"name":"T_02_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYklEQVR4nGPk5ub+z0ABYKJE86gBg8YAdnZ2yl1AiSFUCQNGSg1gYGBgYET2Bjs7O9HegnvByckJQyMxBjEKCQkxODk5wQX27duHrgYjt/78+RPVBTBNWDQzMEDCCAUjuwwAzVAOhzXxUK8AAAAASUVORK5CYII="},{"name":"T_03_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAd0lEQVR4nMWTvQrAIAyEz1K4IW/l5u5j+mxuznZqof42ttCDgMt3XkJiRCRDqZSSOd/bGxgA9lVwmoAknHNDuJuAJKy1CCF0wUsiksvy3j8erHqInxuYcg9IIsY4772VgKQ6QdWC5vfKQAvfDEbLMtTKMTUT/KYDdrMl0y7QvVcAAAAASUVORK5CYII="},{"name":"T_03_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAOklEQVR4nO3OMRUAMAjE0LyubNGGfx9M1AN0bAT8O/j9XpSZvQLUXiFqq2PgjJdfAWzuA5yqIiLGyAXkfAzcFhyvAAAAAABJRU5ErkJggg=="},{"name":"T_03_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVR4nGPk5ub+zwAFX79+ZWQgETBRopmBgYGBAdkF5AAmT09PSvSPglEwCqAAAM7QCOFadaoTAAAAAElFTkSuQmCC"},{"name":"T_03_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAsElEQVR4nO2QvQ2DMBCFv6DIgu6gS0bIEoxBZYkZWIaKARgiBUukTEkJLpBi0ZDmkCyF/BQp+Zo7n/2efA92dv7A4d1F13UxEOvR53nuPxqoICQFRHsHjFsmUSBOgZPWFBARuelMgt+8GihxkiT38GFVVYjIdUu4cgx6X5YldV17a21vjKFpmotzbl1hM4MIQHcbh2GgKIp+mibmeUZFHnh8DXEly7LFGEPbtmd+CPEJjJI4lBL70sIAAAAASUVORK5CYII="},{"name":"T_04_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAArElEQVR4nL2SMQ7DIAxFHxkgElM4Qi/CcTkHh0KEiS6QUtI0sOQvlmz/72/LQmudaaCUYgYLQAhB1JhSAhClfhtF72AE1WUZ9oHWOl8J/sobY/LSJ0MIJ1dXZECItqneoidV0VqvZIBjWku+W0EpdfT+JfUC7RBjzCj17KDF6YizeEbAe79KKfHer9MChbSVo229yOgKq3MOYN5BwR5jfAF7Xxj6g9a2tfZL5A1MzEVciC6VOwAAAABJRU5ErkJggg=="},{"name":"T_04_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVR4nO2PsQ6AIBBD3xmTDmz3/9/IxsCkExiMiMa48ZYb2mtaCyFsfGABkGSSSCkZ8OqauzcNcs7VUOi1lMQKVHOM8bLmORDA3Y8Jd89DSlJPG+nPTJPJ3+yHxCfQT58+6QAAAABJRU5ErkJggg=="},{"name":"T_04_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVR4nO2NMQ6AMAwDnS4esuX/b8yWIVOZKgEVEARjb7FkWWdR1Y4PNACICKkmSZAUkogIETPrAJCZj28kp07M7FC4+61k7MduElQke1p5eSU4v715Xyx+YwNpqyhU+/P64QAAAABJRU5ErkJggg=="},{"name":"T_04_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAu0lEQVR4nMWSPQ7CMAxGXxCSQV6KO3EOjsBRew6GXMhisSBTWAAFCiqUgbdYSuLv80+SqlZ+YAEQEenTKCKISBIRIiIlM6sApZRJNxEZnS2B1F66++iRqtabe0O9t9BiZiOBiEiqWksp9ZpYb8bLybobkWt8MErPrq9aeMevG0RV62gG3/IfgZzzKufcmdnnW2iTgQ3Q9X0/q4IV0AHbYRhmCayBtZkdYN4MTsDJ3ffwxU9sOANHAHffXQCyA0uZo5vtsAAAAABJRU5ErkJggg=="},{"name":"T_04_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAApElEQVR4nLWRsQ5CIQxFT4kJmrcom9/jdzvwNW6NC3ky6QIGfWCAxJuQJi09vVBZluVJQ9ZaAGKMrSsYgBCCfMfULAm0qecozrmNgxjje7qqSs7X3JYAKQuq2rS9eUJqbv5FD+AD0ju9ql9b+QtEWoUSktc2BOh25L0/eu/3PaCaDHAGTrOQXQIArMBj2IFz7goc0hmWUdVLmr5OAYAbcGfCPsALKcI/2B3IAGsAAAAASUVORK5CYII="},{"name":"T_04_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAc0lEQVR4nM2SsQ7AIAhEwTRhYPP/v5HNwclOJJRC1aXxJj3MC7kTwYmZR2sN9Wxn6lsVe6m1+vlUxRtEFD7M/Bdgd5Mr8QczLwEeG4gIAACKCEaBTQEGsqwwg3MAWl1W4SdAqyQi6L3vAaJ/kEEOD/EXwA0tyBuZQYhHMwAAAABJRU5ErkJggg=="},{"name":"T_04_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAc0lEQVR4nM2RsQrAIAxEL6Xg4Ob/f2O2DJnaKSLWWFNo6U3x4J4hR3CUcz7at4iQ+TYDwOYBZiql1NkFpJSW/NAG7c+mfTXc3yS8gYgQMxMAYuY4wNSGHwF6vQuwyrxKbwGqWsOjCqcAVb14I8jPj/gJ4AScfhuZuCtGwAAAAABJRU5ErkJggg=="},{"name":"T_04_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABZUlEQVR4nIWTMY7CMBREnyOw2MKSLRrgCLQcIBeg4gpcIC0FNQehgSYVF+AAtHQo3W4ZS0YCJYW3IGGdEJaRIkU/mcl4/kQQQCnlAYwxbLfbqdb6DGCtnQI/cRxbWojaA4CyLEmS5JznedfjpoBSytdXW2S9XmOtnQEWuHcJ9NoDKSW73W4CjIEBcANucRx/FpBSkqbpBBhrrU/wPP/7I9Q3zjmRpqkBtNb6FEURWZb9x30IOOeEc06EwzzPuVwubDYbALtYLN6m2SAej8cBYJIk+a5ccb1e2e/3XzzyALiHeTQElFJeSomUEgDvfU02gK5es0Bei7xsoSgKiqKgciAqog5KNavc5tAqUphFO5csy4iiiGo7unJlGg7CMimlfCVyXy6X5+FwyGq1QmuNEE/tQa+LHM7m8/kzE2NM3QnLo2B/IXYJhDgcDi+bGI1GXnwihghzUUr5fr/f/Td+Qv3Rsiz5BfuCldDvJTjHAAAAAElFTkSuQmCC"},{"name":"T_04_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAXUlEQVR4nO2OoRGAMBAEdzKIF/8CCc2kmtSTmr4AWqCFmAgcqBTAg8y6E7d3MJn8gbuLu0u0n4ANWKOSpKrnF0kqpaCqBxB6sNRa9967AFdIALQRcs7vJWZ2R5YHD945FiaHbWzDAAAAAElFTkSuQmCC"},{"name":"T_04_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAApklEQVR4nJWSSw4EIQhECzOJC3ccyTNw/yOwZ+UspjXd4KenVgZT5RMgZm74ieCkquPMzKEGAElV6TI3LNTN/hxe3dGsyD7urhvbpDZVuPSIq7BOQaWU8Pec8+7RITPb402IGhx1OgX4sXkdA3xPwh78YzazELLsweTvjxAAyDnTYwpvu3/XIJjMf6awqccm3lVrDbUkIgDO47rMFEJeogMARAR+c7+MgzRoOppFUgAAAABJRU5ErkJggg=="},{"name":"T_04_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAVklEQVR4nO3RsQ6AMAgE0KNxY7v//0Y2Bqa6q4TWNnHxRpp7oQH4sxxR1f7tCiRB8nW/rULtOphFbsAsIiTTK0RECRwAJHt09xJ4/AIAmFlZToHR8pacKkoPCRf6qqgAAAAASUVORK5CYII="},{"name":"T_04_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAI0lEQVR4nGNgGAUUA0Zubu7/xCr++vUrIy0dM2LBaCxQAQAAOAEIA1X/L/AAAAAASUVORK5CYII="},{"name":"T_05_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZElEQVR4nO2RsQrAMAhETSjc4P9/qoNTO1lscoLQoUvfpIkep4r8fM9Q1TMSAI9Pd79jMxtMYFYNEQPYhDPH+pBFWL5CbQV5vEweZ7KCqontoS1Qse1ApLbOKB1UZ2sLvHbQ5QKl6yCt9Y8CJgAAAABJRU5ErkJggg=="},{"name":"T_05_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAbUlEQVR4nO1SuwoAMQiLpeCQzf//xm4OTr2p0GuFHjc3ixAfUYmQ7PgBdxcAwBjwNZrZS1AGERFHVVUFALTWZHAVgCzJrZFkd3dR1S1f1mIzS+8l2SNi+1c97j0NyfiyrpSdcHFxQuqu2c4nYz1vWDBY3wd5ZwAAAABJRU5ErkJggg=="},{"name":"T_05_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIUlEQVR4nGNkIAMcPHiQg4GBgYOBgYGTHP2jYBSMgkEJAB5lAl4wr1jJAAAAAElFTkSuQmCC"},{"name":"T_05_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcElEQVR4nGNkwAKEhIRgzP/I4u/evWNEV8uEzQBSAFYD3r17x8DAwMDw8+dPggZgOAkZcHNzo3jh69evxHsBXTMugNOAbdu2EaMftxewuYAkL3h6eg6wC9DDgJ2dnXwXwDSTlBKRnYsvQdEmKQ8tAwDSjyXwrEHydgAAAABJRU5ErkJggg=="},{"name":"T_05_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAbklEQVR4nN2SMQ7AIAwDTReGbPwqH+ZZ2RgytROVQEGYpUO9YYXDRklYqJRyT1YCADMbzGsFYEUB3B3R62+sSCIyVGithbN0hRl4DKi1hj5dAYhr0AlU9eMEOefhfPwHfRP7DhwnYC5vAYx+AHgAMzso8PH6nwEAAAAASUVORK5CYII="},{"name":"T_05_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKUlEQVR4nGNgIBFwc3P/R+YzkWoAOhg1YNSAYWIAyeDgwYP/CauiJwAAbHQEe5VeelEAAAAASUVORK5CYII="},{"name":"T_06_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAjElEQVR4nO2SuwpDIRBEZ9292Cn4/99oZ7EIY6pAfOQ2CaTJdA7LcfYB/CWvj1IKAIy7+lrrZIRPE/weYKtBUnrv2xyu65IQ9v9kNXLOUNUN0HsXkmitTf6GVNVjVJIDhw1NgJQSSB4BZiYxxs0PS9E49f+Uu98D3B1mts0FAMY4c797BzFGiBwDvNUDN2UrVDK5d50AAAAASUVORK5CYII="},{"name":"T_06_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAhElEQVR4nOWSsRHCMAxFXzgKt9IILOIlvKPn0EJqHVehMXfAoTiBkt9+6elLJ5hIVbdSSugvRwDA4u6o6ovn7lxmgN77rj8FPCa9Tz8F+DnBJ7k7ANdvGw/JzJKIbGaWoppwhdEk43gSQWY3SLVWgPMJhtbW2g1Yo4LdT3yOnXMOIf+uO830KneIPLNLAAAAAElFTkSuQmCC"},{"name":"T_06_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAxElEQVR4nMWSMQ6DMAxFX1AHUBYwE+foARh6VM7RwReKWCLY6GIqFNI27dIvWVa+7BfLMgAigohsJPLen7zUrw6+K4F477cYo9vfl6TeicgWQngWxBjdEXJszgEAXPpr2pSV7eHt+F+rBFB9KvgJoKq1qrYigqq2qloXA6y4A4a+7wEGoHsFyU1QAy0wTNO0A1rziwAN0IjIHcByY1EEWIAlhHADsLxYnJQ7pBWYrflqjbP5J2UvzBZW29gLsI7jmAX8Xw9mY0ZP2W565AAAAABJRU5ErkJggg=="},{"name":"T_06_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA0klEQVR4nJ2RSw6DIBRFD8aoCSNZQjficl0Hq+kMR0Qd0UGheQI2tHcE73PeDwCtdUBIax1y211cnwclee9VSvDeq9xvjAGgTwHGmAAo59wFUqsckwOgOknL3xKUdREABdCJBBUdYRzHu8mKAl3mV4lc6ySCP9UBOjlzoy4L7QEkJFVuBRfngffW89PJzSebc67YQbNSh38DkgqAtXYahgFr7fQzICbNcd5ZQuRS5bs2wrSuK0DRwXmexXVqgGPf9wdwNExwBSzLcgAb8AS2+P+qF2dRWVLVCaXHAAAAAElFTkSuQmCC"},{"name":"T_06_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAlElEQVR4nNWSTQrEIAyFX0sRwVVzhF7E43qOXMhdsLuZTR1EE1uYVd/K/LwvCQhcCiF8oEjLE9Evt9aHiCx988S81Hhriz2kj3vzAKimyRlDbQBoqlARARE9sajTVa2z4hP9D5jdxMzeOQdm9iYg52yaAezXgN2C3J3gU0oAYG9wAzhLKQeA02oYPkardu0Yowl5ub56nDXFofYWoAAAAABJRU5ErkJggg=="},{"name":"T_06_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARUlEQVR4nGPk5ub+z4ADfP36lRGXHAwwsbOzwxWi08QARiEhof8MDAwMP3/+JEkjHAgJCZGsh/ZASEiIcpcNTq+NgmELAJ66FJLOwrVlAAAAAElFTkSuQmCC"},{"name":"T_06_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQ0lEQVR4nGNkwAO4ubn/w9js7OwM7969Y0RXw4TPAGTw8+dPrOJEG8DOzk6ZAbjAqAH0jEaKXTBqAIV5AZdmBgYGBgBFKAo1WS2PqgAAAABJRU5ErkJggg=="},{"name":"T_06_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAPElEQVR4nGNkwAGEhIT+//z5E87/+vUrIzZ1TLgMQNaMD+A0gJ2dnTIDiAWjBtAyGil2wagBVMoLxBgCAIyEDTUV5BZ9AAAAAElFTkSuQmCC"},{"name":"T_06_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABZ0lEQVR4nJWSPY7iQBSEv26N0IyEpecMJiYinQNwAUdOHBFxAS5A7JQLcAXfwcGEpGSWs10S1C21LKMmYINpr7DHM7tTUf9Vva5XTzGCsiwFmIvICcBau1yv1ydjDADOOdW91WMCjzDGsN1uT7fbbfT+6Qve9aOwfdvtdschOYqie7dWQ+bQBhAHwd9pmv7y3vfe/dOCiLyLyBGYF0XxOplMfiZQ1zVaa4KIFEUR/1cT0zQ1gM3znKqq6BLo4JxTzjnV60FZls/Ac9hesyxrp9MpURQBsN/vXwGzWq2uHUcNyDEg4cgCJsuyVoU63nu89705eApEAnkevGKtXQLt+XxWj7ENoQMxBkREjlpr6rr+5Hds3QlI59sYQ1VV5HnOZrM58ZF/b3CGv+lSuAJWKbWM43h5uVwwxpAkSTv2/d4kLhaL++FweAn7vwkkSdJ+5fvRiprNZvemaXrevmvaELppmh+THvEHp2miSxxvHgoAAAAASUVORK5CYII="},{"name":"T_06_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdElEQVR4nO2QsQrAIAwFr6WQ4W3+/ze6ZbaLKWq1dG8PBIO+5HSjIgl3R1IBcPeNCSmlrj7GCxGUVNomYzDopoRFUxcAM5vaAOyrg7Cp4VLXjWMIIOnaT0xvTZZqkjCzJ0Hg4QmDwZKlQdD+fs75VdOf73ECtkEke7cOdcgAAAAASUVORK5CYII="},{"name":"T_06_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAlklEQVR4nKWSOw7EIAxEn1EkCnfc/4x0FK7YYiGKiAlsdiQk4894jJGUEgMqIKNz8He7BidRWsIOKYfndEjcYgBPQe/4dCfnjJlxeMFJxzPPzFDVWkqR0JLH4+GMxxgBUNU6e4MlGomEnPOberkZHc6/mKECMl3PBlkFZLZG4LuqFR4VeLioWivYwc8E41ivFFxJ/h7hAy01KBTRFjnkAAAAAElFTkSuQmCC"},{"name":"T_06_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdElEQVR4nJ2QOQ7AIAwEhwiJwp3//0Y6alJEkchhsHGLZ9ZLUlWsqbUiIr21lqydw6QBVZ3CK0EHpjD3wqtGH9/gquK5oA+pj+TZP2UR+SRGJpdSlqC3QhheClaw64JtgSfdFHjhX0EENi/YFkTTH4IdGOAEvNEp9ZX1NZkAAAAASUVORK5CYII="},{"name":"T_07_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcklEQVR4nKVTMQ4AIQhDcwkDL/P/b2Fg8oaLxIheEDopCW0pWoioQwZE1FeS+T7OJ6EKAMDMJWqgttaivR921na2f0c4EXtGMwRDyZtLRURTvAn1mVUj0DUO1duVagbe0AyBiISb1UHqJUYbFdnfmHbwAg69MreVOeEBAAAAAElFTkSuQmCC"},{"name":"T_07_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAkElEQVR4nO2QMQoDMQwEJyGFjRufXPkdeYCLPPXekUIfMtfZXdLITUihKwNZEIJFOyyCE0opvT696xnAN/0IQFWDqmYRQVWzqgY3wI43oJZSACqwLYinQQAyUPd9X4BsvgsQgSgiTwDb0cYFGMDovT8AbA8bbg7ABA4L3y14mM/FAViPDFZ7ALO1Nj3Zvxx6A4y4K9qt4ACpAAAAAElFTkSuQmCC"},{"name":"T_07_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAO0lEQVR4nO3OIRIAIAgF0cVK4/5n5AoYnDHQwGDhdfYjNJgZQACymsdXOZCVA+7+unmoarQ+yP4HxgDYaFUFZN4ZMfEAAAAASUVORK5CYII="},{"name":"T_08_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANklEQVR4nO3PsREAIAzDQMEImi37j5AVQk9HaPO9dWcYYwCg1s9+A0REP6KWWt3Iui9k5noJHJUJC5lmaSkbAAAAAElFTkSuQmCC"},{"name":"T_08_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANElEQVR4nO2PsQ0AMAyD3J7Abf7/FXdOt2QOO0JIy7IAuVPZdsZl2wEC5HRloJRbC78sSQ+bmgoFaMYl6QAAAABJRU5ErkJggg=="},{"name":"T_08_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAY0lEQVR4nO2QsQrAMAhEn6XgkC3//41uDpnSqSGkIcRuhd7moc9TYaKUUp35r7UCSgTi7q0/5xwD9ElUtc2FAN3m+yQ5N7YC4O69LQCllBr5Aar68I9dwJAgDgAws2X967O6AMddGIRUMAEKAAAAAElFTkSuQmCC"},{"name":"T_08_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAbElEQVR4nOWQsQ7AIAhEj4aEwc3//0Z3Jju0NcagSBx7m3o+jqOUUsWBWERoZVDVanm++8ub8H4eUzYobyYlVW2QPpGbAHjizs48Plqa9FSBjRIXImBzBZcyKud8BojAQvtbsFAHpZSI/Te6AXtXH9QwxU+vAAAAAElFTkSuQmCC"},{"name":"T_08_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAhElEQVR4nKWSOw7AIAxDH6hSBt//mmyZ6QRKUVvx8WKWPCLHSVLlQNnMEkB0d08A0d/eAHn35wbZBjRIB5RSHj6rDFQASbWtFYN19/QXdAZ6IJJqBM1AHhmYWWrXGPW2XQd8DX1Boq6ZwVFxi+UzjoXa6kEM9aiJkup5E1ebNyrDen2jbqqYUq5gVMOgAAAAAElFTkSuQmCC"},{"name":"T_08_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARUlEQVR4nGNgGL5AR0fn/0C7AeIKQi5hJGSAt7c3XkuYyHAY8QZcuXIFrwsZGAh4gYGBgUFKSor8MIABXAFJjAtHAREAAOFFDr9iyOacAAAAAElFTkSuQmCC"},{"name":"T_08_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYklEQVR4nO2QwRGAIAwEF8cqqOH6ozI6oQbaiC8d0Ig6ftlfcpnkLjD5TfCakqytSynuHMCaUrI7ESDnPHSwDNUXPC7Y7UuyczSAEGMcRqi1dvklWfuTY7t39ROePa83ubIBtIQdGK5fjlEAAAAASUVORK5CYII="},{"name":"T_08_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATklEQVR4nGNgGL5AR0fnv46Ozn+KDKCKK8g2FOYFmCZcmplIcQk2Q7AagMu2K1euMBI0gBh/IqshygvItqNbgOEkbIqwOZ0oQJW0MPgBAN7vITTsVz3rAAAAAElFTkSuQmCC"},{"name":"T_08_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAe0lEQVR4nLWQMQrAIAxFf1zd/p5L9iBeMrubeyclFVqrtg8EDd/kEWATUdUEAGZ2PAVrrif0AVVN9fj3aMAycqfmJz4ZSA2MmvzGxcDMDm/zysBv3Nc+Fr1HSKYYYyvMLi4AQCllfeMkQbLdZwkAUv2cc15qsIV47RWDE71gNUYRPDztAAAAAElFTkSuQmCC"},{"name":"T_08_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAhklEQVR4nM2TsRLDIAxDk67atPsn+RB+0rs37Z3McZAQrh3atwDmLIQNx7EBydu908xqH3D3knMzq5LaOiImgdcYSMEcAbQDrpycD+4bY3K6uRUYryapTy4kK4C1gyuRiGg1IVnnrAUklx3ZFvkfSO63MekLK2l+SLu4ewHwafqvGf/LV7wBXJQqOpR4HgQAAAAASUVORK5CYII="},{"name":"T_09_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcklEQVR4nK1SywrAIAyLUujd///RnLbLFJ1GsFtutuZBaCql4MGFAHJPJgmSxwKT80pkJU4Spkgk4e7T7v3PlONu3iMDaE4R1BKliLtvDbLcnCZQqD2oFLacChGVINVHpMxfOmiXeHrGQ4IIeRCI4rPADfPiM5wTuQaPAAAAAElFTkSuQmCC"},{"name":"T_09_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAaUlEQVR4nM2RwQ7AIAhDiyHxwM3//1FO7uTi6sKmW7L1Rij1gVJKqViTAIBGDnc/1DnnvqwAZAjgIe5xiJjZ9Ap9SJodbiRNyonRCq8Q0A0k8atkuNROcAf9xFc1aM4RrOrxN35D8K+ADSZ9Iz3AivhQAAAAAElFTkSuQmCC"},{"name":"T_09_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAI0lEQVR4nGNgGAWjYBQME8BISIGlpeV/bOLHjx9nZGBgYAAARkEEAnF6nuMAAAAASUVORK5CYII="},{"name":"T_09_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKUlEQVR4nGNgGAWjYOQAS0vL/7jkmCg1nKAB+GynigsYSbH5+PHjGOoBWdwHXAwjg4UAAAAASUVORK5CYII="},{"name":"T_09_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAS0lEQVR4nGNggAJubu7/QkJCDEJCQnA+AxGAiYGBAa4JGXz9+pWRKAOwaSYFMFGkm4GBgendu3eUmgEBxAYahgsotXjgDRgFwwIAAJwGCfGE0kBuAAAAAElFTkSuQmCC"},{"name":"T_09_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASElEQVR4nGNgGAUUA0Zsgjo6Ov+R+VeuXGFEl7ty5Qqjjo7Of6wGlJeX/8cmjg0wEauQZgZg9YKUlBTRXsBqADaAL2BHAYUAADvAET0G9ZpaAAAAAElFTkSuQmCC"},{"name":"T_09_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATklEQVR4nGNgGH5AR0fnP30NwaVYR0fnPzEGMZaXl5Pk5M7OTkZkPhMpmrEBig1glJKSIskLz549Q/ECCgdXoF25coURmzhBQJU0MQIAAHmtFRqPS9tBAAAAAElFTkSuQmCC"},{"name":"T_09_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAR0lEQVR4nGPU0dH5z0ABYLpy5QojNglc4uiAoCKYC2EGoruYKFtwGcrAwMDAhE8RMeGD04ArV64w4nI2UQbQHFAa/aNgeAEAoBsYlSL+5bcAAAAASUVORK5CYII="},{"name":"T_09_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATklEQVR4nO2QywkAMAhDo/Nk/0myjz0VSkmhn2sfeDAYjAYAkCxcki9mSZFj4wac1gsAgmRJijmJMztyd/Pq1HSiM20l6gaS9fLcz+eYBiRzKQWPAq0eAAAAAElFTkSuQmCC"},{"name":"T_09_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAq0lEQVR4nK1RsQrFIAy8dhLcHAP5ST/EnxQc3QSXwBteldg+oX02UxK9y10CvBHMHJg5LBG8omQp/rWxNzAAlFIeD95a4pzrzZzzfQItu5QCay0AIMboHyn45f8uyVJsutAqYoyemYOIIKU0VbK3xDk3gIkIIuLPbxcFevvA9wJE1Ota6wWkr6QJ+hRjjFfg1vfnfwOBMSYcAH/UUwWaZFgiEQ2AZmdCAgD4AKAoSWIXiS5PAAAAAElFTkSuQmCC"},{"name":"T_09_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAqklEQVR4nKWSsQ6EIBBEn8cVJHZTkviTfAifuSWdiaXFoZHzUE+nWgLzdliABwoh0N00plLG14MAEfg/QQhhrc2MOwkSkMwM4BYA5xzDMKTzk19a4m+vcXkGxVR1dc5dA0jamfm8QjoFFHNTh4CN+Vf3Y0AjdmXeASThvWeapqNglTpJp+/Z9321HsdxTfEGyDnHAlo2EhC995gZOecK0BysJCRVH6WlBTID62QjXdGJNCcAAAAASUVORK5CYII="},{"name":"T_10_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQklEQVR4nGMUEhL6z8DAwPDz508GcgATWbqobQAjAwMDAzs7+8C5YHAYQHY4DB4v/KeKC8hJznADKM4LVEmJAxKNAFn/C2vgd6KfAAAAAElFTkSuQmCC"},{"name":"T_10_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQUlEQVR4nGPk5ub+z0AiYGdnh7OZKNFMlgHogGQDfv78icxlpL8LhpcBjAPjAqSE9H9gXICWkCh2wf+BiUZkbwAA8TsMQFCIXukAAAAASUVORK5CYII="},{"name":"T_10_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAbUlEQVR4nMWTsQ3AMAgE31E6i9a7MI4HZwrk2mkTBaR3UvjLBw4EoiBRa21msbsOJmkZoKpUdwA42cTeOz/Bin4DSmSq6jSzhzfGCAH0Dmqtob9/B/sB4RWA/BdEBO7+bQIReXk0ICqmAVkxAFzJpxAnwIgspgAAAABJRU5ErkJggg=="},{"name":"T_10_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAfElEQVR4nGMUExP7z0AEUFZWZjh+/DgjujgTMZphwNLSEsMykgzA5gKWxMRErIrnz59PlKE4XcDLy0uZAegAm/MZGBgYGLm5ubHGAjc3Nwr/1atXWA1gQVaI7OzPnz8T5TIULxCrCcUF6AKkGkJSOqDIAGypkL4uGLwGAAAjKxwfxh1agQAAAABJRU5ErkJggg=="},{"name":"T_10_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAnUlEQVR4nL2SwQ0EIQhFv5upwCM10IkFURAtUcO0wV7WCWPQcbPJ/pua9yAI8I8ws4/nfnfswszsZlYAoLXWn33GpQJmdhFxInIieoZHUYfjfdmBRcQBQFVxnueNee3CsywFEc6qLwVPlS/B+Mff5jCzEiVmVrLqWfvAZ5GiZOxIVZcdXDNItgyqilrrtPpNECUR7tmeVbamvw56mTctOlR4TDG15AAAAABJRU5ErkJggg=="},{"name":"T_10_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAUElEQVR4nMWRuQ0AIAwDCfPc/pN4n1DR8EgEELj3yU9KQQEe9dzV/wTHaivkU+BbwOiBDhC9qQNIskiS5QqAj+BbI0qymuLPiLUO4LZqmqkA4T0dr14ukhgAAAAASUVORK5CYII="},{"name":"T_10_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARklEQVR4nGNgGAVDGOjo6PxnYGBgYKREM1VcwUSJZgYGBgayDED2AkkGYPM7yYGIbgjFLiBoAEwTrqhjwhenhDQzMDAwAAA8exO2QuZhVQAAAABJRU5ErkJggg=="},{"name":"T_10_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAUUlEQVR4nGNgGAWDAOjo6PynRD8TtRyCAsh2lY6Ozn9SNTPBNKBrJNYgJlyar1y5wkiMQTgDEabxypUrjPgMoTgW8BqAHqjYXEK0C5DDBdkwAMogITkh7vKrAAAAAElFTkSuQmCC"},{"name":"T_10_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAmElEQVR4nK2RPRLEIAiF0dnOjp5L5iBckp6OfpvoKEsMmeyrlB/5eAK8VMkWEhH7mIgcNdNIRCwix1O6lFIrdIJojdsHoqa/aiHwZl05P8dLVHy1b/QTWw8QcZxVNV4BEbm19pMwsz6NVXVMRsTlXs/igWdmczMAwILth5WOqaoL8g57VgUAPtHSzbPBH5+8m+p/p2Sc3ukLcEBMh+WLC6YAAAAASUVORK5CYII="},{"name":"T_10_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVR4nL1RMQoAIQyLTs4dhX7Sh/jJgm9wvMlD0GoP9LKUUpPGBjgFZs7MnL/y/EzojCUjnLZdRJJFYPjCTOwutE3WVLyIpN8v38OthpZU7qYQY9y+UR00cquao+EGRIQQwtuXUuwOiAgAUGtdkno8jXMbJdQj8e0AAAAASUVORK5CYII="},{"name":"T_11_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZUlEQVR4nK2SQQrAIAwEVynsPf//aE720EYK1VaT7EnQjMOSIiIA0HBHVbGTGhk2QCgd4PndACXFgKQb0H5frRhEOgglpYMcg52Q7MZ1dvE1/DwPDUaQGfzAtYmvXVgt1Qzc63wCoBMQ/+acUmIAAAAASUVORK5CYII="},{"name":"T_11_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAUUlEQVR4nGPk5ub+z0AGYGdnZ2BgYGBgIkczMhipBsACcOBcMKgMYKTcBezs7CihSrIBMAbMEBIN/M+CzEPWiMz++fMnThNYcMrgMBgdUBwLAIBMBgJB6A9WAAAAAElFTkSuQmCC"},{"name":"T_11_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAPUlEQVR4nO3MoQ0AIAwF0Q++tvvveAOAIGkaAoJge/LEa7rk7mN/ZiZJAuL1G3AKEBDQM5ChLyBXQAEFrCZ99g0THdz6SwAAAABJRU5ErkJggg=="},{"name":"T_11_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdUlEQVR4nM2Ruw3AMAhEDystLQt4/znYxS0DJJUj/2JhR5FyJdI7joNE5IRDMUaoKrXz4IFn+s6AmV0GNOqAmWFm1Syl1N0/TJA3exN0BuVmj8kPv+C9PeuYge0nHhPswgAQ3sAAEMysA1Z6uDtY2Vol2KIKXcvqIHHjf3V9AAAAAElFTkSuQmCC"},{"name":"T_11_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAjElEQVR4nO2RwQ0DIQwElyjl0IlrcB0uyDW4E/pxPoDuYO8SJd/4hQQzXmPgXz9X+QYys3l+fALUWpPBbwUDbK0VBgPA867bsRhME4gIRte1c0Rs8k0QEVOywiJSVgndgpnl8a7D9D39RHcHgFxjsxE244js7qmqzH9iLteoqqUnuaq8FXQJBd19jvICRHJAfcYkMa0AAAAASUVORK5CYII="},{"name":"T_11_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcklEQVR4nO2QMRXAIAxEP7yqQEOcoCE6ogEdaMAJfuhUXgdoBxg69JYMyb9LAr8+IDNb4v2qiV+K32XQdmzwaiIiw5l+gpm1exWRdkEzGMCFEJqqDpulFABqrW5m4FXV5ZyHzRjjjOs6UkoAjskfntIBTjBhH6qjFYNcAAAAAElFTkSuQmCC"},{"name":"T_11_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAK0lEQVR4nGNgGAWjYEgBHR2d/9jEmSg1eJAagMu/JLkAmyE6Ojr/YeIwGgAqLwkdnZb73wAAAABJRU5ErkJggg=="},{"name":"T_11_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAM0lEQVR4nGNgGAUDA3R0dP7D2EyUGkZ7A5CdOzAuoAmgbywQFYi4FMHE8RnCREgzIZcAAPfZDzHN07BTAAAAAElFTkSuQmCC"},{"name":"T_11_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAOElEQVR4nGNgGAigo6Pzn2qGMFHqArIMoAqgyAsjHVAlEQ0sQPcCIy4JQuDKlSuMDAwMDIyUBgoAsjsOnhS3AFcAAAAASUVORK5CYII="},{"name":"T_11_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAuElEQVR4nKWSPQ7FIAyDTadIbB4jcUkOwiW7Z+6C9JaGQl9LVfWb+LGDIQAfCSml4pN1XfNZ0O9fsczMnyH5qAk+SCmVPgXJFj3GeJtwuTL3xBhfZH6Jqh5dmD3iuRO11qYN//L7IrVWAMC2bQAAEXkX2SE579DT55niZlWFqj7qg0cxM5CEmQ1Gv2+/75A8CgBosUUkd2Zf95cvZpb9o7UCIlJ2Q97nQ4IT7bChjao6GPw6N0UAAD8Gt1CiUi5oaAAAAABJRU5ErkJggg=="},{"name":"T_11_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA0UlEQVR4nJWTwQrEIAxEn2UPQm85BvzJfoif6TE3wYuwl03ZWu2yA2KZMckY08AAETm/zWyUbwgppVxrZd93eu+01jz4+BkNbLVWAHz/JxgguO0YIwCttal1VaWUcuNfKaXcex/5iwNVXTrYPLiUsrTtlaeJRvKp2kzbgDxwWURG7tRU9aKFVaVZw74T+0u9ln7nOPskIpgZ2+yUD9MEma8rn1P7cOcbROSywtPsu81ZEkcYq3tzZg0D+Pw7xyqBCxk4Yoyr17g4uB1YBY5JzIw3Lzxh6ALZotwAAAAASUVORK5CYII="},{"name":"T_12_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAL0lEQVR4nGNgoADo6Oj8p0Q/5UBHR+c/EyWaqeICig0Z4oAqsUC2ATAwagAVDAAAxmQJI9lWRpIAAAAASUVORK5CYII="},{"name":"T_12_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAI0lEQVR4nGNgGB5AR0fn/0C7YRQMPKAkHTBRavkgMoDccAAALUoEkivEINQAAAAASUVORK5CYII="},{"name":"T_12_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZ0lEQVR4nO3QsQ3AIAwAwXdGoGQGVmIOD8RKzEDJCqQJKYiRIDVfWQIdyIKRqr5zSqnFGK1rAMjsYEQALGgKjHnvTeRaBUop8vzmHwDgnGNEtgALWdpBCKEB5Jylz7XW3be/9cWeTjcwMh+rxycIugAAAABJRU5ErkJggg=="},{"name":"T_12_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAkklEQVR4nO2R0Q0EIQhEcXMV8EkNtEQd1GAd1GAn1kAb7s/p4XpawOVeYmJAxxlM8IaImohAxMzA3RMcuPrG3ZOZTU0RASJqJ4FFvV+IbnLOWxfXs4CIy6GTi0tVlyYiQozznM2EqrYowsxjT0Str1hfIpRSRqHWOvL2H/gWq/Pae/uIuPvkLj4yBsTMW5t/fp4bCbs6Hj5qrhQAAAAASUVORK5CYII="},{"name":"T_12_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIUlEQVR4nGNgGAXUAzo6Ov/J0cdEqcUDb8AoGFSA3JQIAIruAw2ZSAXyAAAAAElFTkSuQmCC"},{"name":"T_12_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAoklEQVR4nLWSMQ6DMAxFX4CB+Y9IuWQOkksiMXqLxILUoQJZKaIQtW9KHPv7O0kAmKaJnXVdj/U4jqdxT/DFPtnMqMU9y7K8BWKMedu25INXxBiz33cAfd/nluKfEHbVeZ5Ti4PubuJf7AOEOw7q8fz56QhPBZuRdM/BBfmRgKT2VpI+BCQx1Iln711KScAe9xeYh28fpJSCmSEJMzuKJWWAF7WfPRmyIAcyAAAAAElFTkSuQmCC"},{"name":"T_12_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAo0lEQVR4nL1SMQ4DIQwz1Q2RsmXPJ3kIn0RizMzYKShHOXqq2lpiwHISO5BEBESE3juICADQWsPfkFS1AECtNe+ErpvxmAWqWvxE4bsBHyPFSbXWvIu0ipGuss0Nf4bTK8xxgLPtFfeSa2X5irsVT0TGiZzjEJHCzINYbH9M8UJmhpllAEgiUvyycTGaMPOXP1Xs7jZjxhXi8g4vcpjZ7WIAeAK4G0fAq9jhnQAAAABJRU5ErkJggg=="},{"name":"T_13_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAT0lEQVR4nGMUEhL6z4AFODk5Mezbtw/OhgF0MUZcBhALWJA5P3/+xKqInZ0dpwGM3NzcRLkA2RBki1iwKcYGcLmOiVgDcIFRA0YNGBwGAAAaPxNd9MR1bAAAAABJRU5ErkJggg=="},{"name":"T_13_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATklEQVR4nGMMCQn5v2/fPgZk4OTkxIAu9vPnTwZsgFFISOg/VhksAJshTJRoZmBgYGD6+fMnTklCmhkYGBhYiFGEDxDthVEDRg0Y3AYAAMxAHPiNymzqAAAAAElFTkSuQmCC"},{"name":"T_13_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAS0lEQVR4nO2PsQ0AMQwCcfSSC3ds5f2nceVvPhnAdNFT0dwJLCIaQpYC/4JPkJmSwACAZFfVbMEu7q4JplkkGwCmF54peBZI9B2CF0UoDVw3I1eGAAAAAElFTkSuQmCC"},{"name":"T_13_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVR4nGNkIBPo6Oj8Z2BgYGAi1wCqAB0dnf8Uu2AkG0C1aBypBsACcOBcQFUDAFlmBio29rvzAAAAAElFTkSuQmCC"},{"name":"T_13_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQklEQVR4nGNkYGBg0NHR+c8ABVeuXGFkIAEwkaKY9gaQ6nyquICBgQE1EOnuAup4YXAAcgOSCVkzOYYMfCwMfF4AAPBFDx4D27xOAAAAAElFTkSuQmCC"},{"name":"T_13_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAALElEQVR4nGNgGAWjYBQMDsCITVBHR+f/lStXsMrB5GFsJnQBGBtZDFkOXRwAHtYNFr791bIAAAAASUVORK5CYII="},{"name":"T_13_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIklEQVR4nGNgGAWjYBRQB+jo6PynRD8TpYYwUqL5ypUrjABFYgcKlkqJIgAAAABJRU5ErkJggg=="},{"name":"T_13_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAJElEQVR4nGNgGAWjYBQMMqCjo/OfFHEYYEJWhK6YkDgDAwMDAFHrCpjFtDA8AAAAAElFTkSuQmCC"},{"name":"T_13_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANUlEQVR4nGNggAIdHZ3/DKOAMkBuIDJRavGoAcPCABZCCQhd/sqVK4zIfEZsiogFV65cYQQA0KgMn3tKq44AAAAASUVORK5CYII="},{"name":"T_13_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAvklEQVR4nJ1Tuw7DIBBzSoZIbB6R+Ek+5H4SKeP9AVKHlujCS208hTNn+wIAC5Bcciv+J5DEZgsxRsk5J+uuqiAp3vuhyDasGgcAAiB57+VxzBX2+hFjnDqoamr5OurLFkspqZJ1wwxV8PoHIYSLPM9zGdtib5udcwIgWZc2jR1nmwjcsBqnE/gn/khAnHPdJpuApKjqte4S1BT2VppmqCqAB6dgm6dok9jYIYSOJym3i9Q6f5+sHMcBfN5EhzdZ9E136R2kdgAAAABJRU5ErkJggg=="},{"name":"T_13_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAwElEQVR4nL1SMQ7EIAwzpxsssTFG6id5SD9ZqWM2JJZKnYJSDtobTueNYDsmIaSUYFBV/B1hWZbVDtu25Z7g7z2M2wxG4ieTnyD0XUopH6QY4zRheBKr6vRplwR+nU58pwUAvP2ASimIMU67G/c4jlYPIwJw3YoTAgBqrQAAkleDO4hIE3p8lUBE1pGYJF52SClNf2QvJglVzbVWhH76qgoRAQDs+/64HW/QEpDMrrPVs+fZhpoBSXtntpij+L3JCc95bFg+xxruAAAAAElFTkSuQmCC"},{"name":"T_14_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZUlEQVR4nO3RoQ7AIAxF0QsGUcf/f2MdAsXUkq3rmmKm9lSBctKk8KecRe99Xc8AqpoDRGQBtNbCZlUt9u4GeLGoRWr0GWDOGU5Vw9cEkgIiJA28IVvAGOOxhS3AyxbgbezbCbwc5CEc4u6BA8IAAAAASUVORK5CYII="},{"name":"T_14_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAfElEQVR4nKWTQQrAIAwEVynsPU/yDXmmb/BfOdmTxWJpMO4pSDLsRpIAQES6mSGiPAqScUApJQzJAFBrTQMSApxoAezGuL4eZ4j3O24Ekr+u0ihEpH81HDvwdAx4LdHMQNK1vThQ1Sf/7k1kVe2tta2hWWls/+gao8MAcAOxQiVtAo85DAAAAABJRU5ErkJggg=="},{"name":"T_14_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAS0lEQVR4nGNkIAPo6Oj8h7GZyDEAGQxRA65cucJIqcUMDAyQwBy4MIBFJVkGUJQOkDWT7YKBMwDd+SQZgKwZOSGRlKIocgG6zTAAAGYzE6waQSA7AAAAAElFTkSuQmCC"},{"name":"T_14_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAPElEQVR4nGNgYGBg0NHR+c8wCkY8oCQdMFFqCBNhJfQ0gBxvYLhAR0fnPykG4fQCsYbgNODKlSuMxBgAAE1eDSGR9aeeAAAAAElFTkSuQmCC"},{"name":"T_14_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAOklEQVR4nGNgGAWMpGrg4+P7j8xnotQFowYMBgMw0oGAgMB/bAph4N+/f7hdQEgzNsBCjiacLiAHAABtRwfJKHSx2QAAAABJRU5ErkJggg=="},{"name":"T_14_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVR4nGNgGAWMAgIC/7FJfPjwgZEYA5go0YzTAFyuItoAUsBwNYDiWKDYBUPLAADm7QrpT7FlTgAAAABJRU5ErkJggg=="},{"name":"T_14_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAp0lEQVR4nKVTMQ4EIQjEzRUmdJQkfHIf4idJLOnor8Jzz9ONe1OR0cFh1AQLEFGrc86trrWuZHtIIlJ6QlXPmRszG/hjJpg1GRw8EfdOEgDA9xgBVT1jzd1D3ByLSBkyWMHdLw22QURDDhcHfaAznogAEUtwr10XZgaICCJSIpfHIKLPNe6EGXB3OP5xgIjrDcx82+T2JTIz1FqnI/4cIU4OMcD8k70B/J1FG4u3lX0AAAAASUVORK5CYII="},{"name":"T_14_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA8ElEQVR4nIWTsQ7EIAiGsd7gzEjiS/ogvGQTR7YmjDdcIUh7LUkTi/L7/YoFQhARqKr/i8gll6PkBCIuAm+x3eTYvt47997ZJmxMRJ7bEJER8TJhse/7iOO8phh2aw0AwP1mfCKCOScQkefmnD8sUyUipwmFHIsy6d0h8klguG7hJOBaq1taBGyneG1mLYn88CNBwORTYMTCU2ixV2uFkjEtbpon39AAAC75gF5EQESWZvuYsi1urY1/u4vIyCKbqsKc0y2oqnWiFTq63VAkWG7BGurp8eT4ZNTQiQMRWURGfA8AAMdxOPGFwDw+RbTwBatTgWxLNOFbAAAAAElFTkSuQmCC"},{"name":"T_15_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAa0lEQVR4nMWTsQrAMAhETylkcPP/v9EtQ6Z2qhg6JGigThq8xxmURORGIbi1VtGDAaAC4TfJQjgWGQivWxaAMYYXMd+NKyt0B713Sqtx4g8AoOLijINfAdPsu5cZN9YBquqPZuaw0Exm9oE9v1gYSshZMnUAAAAASUVORK5CYII="},{"name":"T_15_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAVElEQVR4nGPk5ub+z0AC+Pr1KyMyn4kUzdgASQag206yAdi8S18vkG0AOzs7Azs7O24DYAqwKUTme3p6YhrAzs6OEbLYbHNycmJgYGDAUDsKhgUAAPzzCnKowCnyAAAAAElFTkSuQmCC"},{"name":"T_15_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAWUlEQVR4nNWRsQ0AMQgDDQ09s3nejERPxVfJAM5Lr6ej8OkwlpnT3VDHASAidEBVmZzeBt8DqsrUHt4xICm/0knOWks2sMycvSgWpwP5hJswAPhN+Bj8G/AAsB0f+3MNb6sAAAAASUVORK5CYII="},{"name":"T_15_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANklEQVR4nGNkIBHo6Oj8R+YzkWoAOhiCBly5coVxYF1AFQOQvTFEvUBVAygC6PliYFxAcRgAAOgOCZ2+AEm4AAAAAElFTkSuQmCC"},{"name":"T_15_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMklEQVR4nGNkYGBg0NHR+c8ABVeuXGFkIAEwIXNI1YxhALJL6OYCsm0eBdQGo7EwwAAArk8NiwP5EqkAAAAASUVORK5CYII="},{"name":"T_15_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQklEQVR4nGMUEBD4z4AFfPjwgRGbODpgIkbRMDeABZcEHx8f1sBlYkLY+eHDB8aB9wLZBsDSycC5AJaCh3AgDh4DADcrDCLseyDoAAAAAElFTkSuQmCC"},{"name":"T_15_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARUlEQVR4nGNgGAWMDAwMDAICAv+xSf779w+F/+nTJ0Z0NUy4NBMLmCjRTH8DBAQE/qN7mSwXIBvCQo4ByIYMsUAcnAYAAJ9JDQWO3jyuAAAAAElFTkSuQmCC"},{"name":"T_15_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASElEQVR4nGNgGAWjgIGBEV1AQEDgP4z9798/BgYGBoZPnz5hqIMBJlyaiQUs5GjC6QJyAAsxirC58sOHD4xEG4DPUIq9QLEBACatDqN+2gdpAAAAAElFTkSuQmCC"}];
const BG_TILES = [{"name":"BG_00_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAHUlEQVR4nGOUU1D8z0ABYKJE86gBowaMGjCYDAAAzn4Bfug+Yw8AAAAASUVORK5CYII="},{"name":"BG_02_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAaklEQVR4nGOUU1D8z0ABYKJE86gBEMDCwMDAYOgdKQYTOL91+StSDGD0z64SRRfEZwiyZQwMOLyArgifOMVhgNUL6ADZS0R5AR3g8hLRBuADJBuAHkNMxMQ7uhpkPouhd6QYTACfX3EZCgC5bCcno73MoAAAAABJRU5ErkJggg=="},{"name":"BG_02_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZklEQVR4nGOUU1D8z0ABYKJE80g1wNA7UszQO1IMxmckNhaQNcHA+a3LXxHlAmyaYYAJnyQ+cH7r8lcMDGQGIkwz3AByXUG0C5BtRGYzMDAwsBBrE7pGmKuZsEmSAohOB7gAxUkZAOCJIDqy3HQXAAAAAElFTkSuQmCC"},{"name":"BG_02_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVR4nGOUU1D8z0ABYKJE86gBw8YAFhjD0DtSDFni/Nblr4g2AF0zNkNxGciESzMugK4eaxic37r8FbEGkxWIyIZjGIDLdlwuYkIOHFKcDgMAWbQdLpFD8fgAAAAASUVORK5CYII="},{"name":"BG_02_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAaUlEQVR4nGOUU1D8z0ABYKJE86gBDAyG3pFiJBtg6B0pZugdKQbjs5CiEZs4XgNwaUIGFAcihguIsRUGzm9d/gruAljgnN+6/BWxBhh6R4phdQEphrDANKEbgk8TsgWUp0RSAg0GkPUAAFLpGra9swA+AAAAAElFTkSuQmCC"},{"name":"BG_02_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdklEQVR4nGOUU1D8z0ABYKJE83AxwNA7UszQO1KMgYGBAZlNkQtIMQSnF4g1hImBgYHh/Nblr0h1OtyA81uXv8ImgUscwwBybYYbwMAA8S8+G/FZwoKsCJshhFyIEgv40gEucYIp8fzW5QfwybPgk4QCLXzhAwAQMyTaiKeUDgAAAABJRU5ErkJggg=="},{"name":"BG_02_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAJklEQVR4nGOUU1D8z0ABYKJE86gBowYMIQMMvSPFBs4FhGynigsA+ScDVFMxvQ0AAAAASUVORK5CYII="},{"name":"BG_02_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAiElEQVR4nGOUU1D8z0ABYKJEMwMDAwMLqRoMvSPFYOzzW5e/wuoCZEX4xA29I8WY0AVginAZgg5QDDi/dfkrfIqxyWN4AaaIkGEwwAiLRpiTsWnE5x2MWEAPZUJhwUTIBkKA4oSE0wBiAxGrAcRqZmBgYGBC9z8xAYcM4LEAs5XUAMVIB6S6BgBNUDjVZhA34QAAAABJRU5ErkJggg=="},{"name":"BG_02_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdElEQVR4nGOUU1D8z0ABYGFgYGAw9I4UQ5c4v3X5K2IMYMKmGZeh2ACjnILif0KK8bmGydA7Uuz81uWv8CnCZwFKGBDrbwwDiLHp/Nblr5DlYZax4NKADyAbxkSOAciAZAPQvUJfF6DbTrIB2GKJ/oFIdQMA/lotpAzuQ5AAAAAASUVORK5CYII="},{"name":"BG_02_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAV0lEQVR4nGOUU1D8z0ABYKJE86gBVDKAxdA7UgxZ4PzW5a9IMgBdANlAQoYZekeK4fUCuuuwAYrC4PzW5a8IGmDoHSmGzyVEuwCXIUQbgCtA6ZeQcHkBAFIOFS7IkAqyAAAAAElFTkSuQmCC"},{"name":"BG_02_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZUlEQVR4nGOUU1D8z0ABYKJE86gBEMBCrkZD70gxsl0A08zAwMDAhMwhVTPcBYbekWLEGIRNDRMhBYQA9aMRn3fOb13+Cl2MUU5B8T8+Dehy6GJMuEzGphnmQmT1WBMSLs3YDAEAP5crIgaqcZQAAAAASUVORK5CYII="},{"name":"BG_02_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZUlEQVR4nGOUU1D8z0ABYKJE86gBUAMMvSPFKDGAhYGBgcHQO1Ls/Nblr3ApQrcEWS0TLkX4xJHFKA4DRv/sKlFsEsjOxOW681uXv8LpAmIDlz7pAFsMwcSIdgGyIchsFnJsRQYAf44o9CEn0mUAAAAASUVORK5CYII="},{"name":"BG_02_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAVElEQVR4nGOUU1D8z0ABYKJE80gywNA7UszQO1IMmxwjvljApun81uWviHIBLhvRxckKA2RDWMgxANkQ2sUCemDhAnhjAQZwBSheFxAL6GMAvvAAAKHyFNF563YaAAAAAElFTkSuQmCC"},{"name":"BG_02_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATUlEQVR4nGOUU1D8z0ABYKJE86gBw8YAFkPvSDFkgfNbl78iyQB0AWQDiTEMwwBCAN3FJIUBumaSDMCmGa8ByP7HpRmnAcRqZmBgYAAA4KcURZM+JywAAAAASUVORK5CYII="},{"name":"BG_02_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAaUlEQVR4nGOUU1D8z0ABYKJE8zAxgIUYRYbekWLYxM9vXf6KkVAs4NIMA3i9QEgzAwMWLxCjiWgXkGXA+a3LX5FkgKF3pBi6s0kxBO4Ccg3B8AKyQcQYgjUQSTGE0T+7ShSmkBhvoKsBAHV2JuhoQw3fAAAAAElFTkSuQmCC"},{"name":"BG_02_14","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASUlEQVR4nGOUU1D8z0ABYKJE83AxwNA7UszQO1KMYheQawiKF8gxhLqBeH7r8lcD6wKKDCDH+QRdQEwaIcoL+AzBaQC6JlyGAABEsA/ryXGQuwAAAABJRU5ErkJggg=="},{"name":"BG_02_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVR4nGOUU1D8z0ABYKJE86gBg8EAQ+9IsYFzgaF3pBhFBsAAC7qJDAwMDOe3Ln9FrAFM6Jqx8QkagA3gM8TQO1Ls/Nblr85vXf6KUU5B8T8+xbi8Q7VABACElBd0J4hSbAAAAABJRU5ErkJggg=="},{"name":"BG_02_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAfElEQVR4nGOUU1D8z0ABYCFXo6F3pBjRBsAUMzAwMJzfuvwVMp8FmyJSABMpitFthxtAru0MDCQE4vmty18h03ADSLUdqxeIsR2XRQQNQHcyOsAbBsg24zIIqwvOb13+Ct3ZuLzAgqyJkGKsBsA0kpsWSI5GdEBSUsZmGQBYQjU8oliTrwAAAABJRU5ErkJggg=="},{"name":"BG_02_17","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAUklEQVR4nGOUU1D8z0ABYDH0jhSDcc5vXf6KVAOYkDnIhpFlADmGsCBzYF6AGUKMl1iQFZHjBUb/7CpRYhVjcxELNoW4ADYXYgQiqWDUgGFhAACf+xe51ocIZgAAAABJRU5ErkJggg=="},{"name":"BG_02_18","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAX0lEQVR4nGOUU1D8z0ABYKJE86gB1DLA0DtSjBIDWBgYGBiQDTm/dfkrfBpgamHqMLxArIsMvSPFDL0jxUgOA3QXYjUAZjoxBuJ1ATGG4DUAV4Aii5OdDnDGAjIgxgsAJ+UdLINFJuoAAAAASUVORK5CYII="},{"name":"BG_03_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAaElEQVR4nGP0z64SZYCC81uXv2LAAwy9I8XQ1bCgK8CmEZ/BTPhsJGQ7SQZQ7AKYK9C9SR8XoNuKzKfcBYTiHhtA1sOELkCyC7CZSqztKAaQo5lkA7ABuAG48gFRBpCrGcUFhACuQAYAxU4rlV3p5YUAAAAASUVORK5CYII="},{"name":"BG_03_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAUUlEQVR4nGOUU1D8z0ABYKJE86gBw8IAQ+9IMbINMPSOFKPYBWQZALOZLANgmg29I8XOb13+ioGBgYGR2MyEbjMDAwPD+a3LXxFtAC5AcSACAJ9BD+Q7HKDjAAAAAElFTkSuQmCC"},{"name":"BG_03_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAZUlEQVR4nGOUU1D8zwAFht6RYgx4wPmty1/B1JzfuvwVAwMDAxOxmnEBJsJKqGgANleS7QKYYUy4TCYWUB4GlNhOHRdQotnQO1IMxQBY6iLLBTDNpBpCcRiwkONsgi4gxVCKvQAAYnIea/TWZ2wAAAAASUVORK5CYII="},{"name":"BG_03_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAUElEQVR4nGP0z64SZSADnN+6/JWhd6QYEzmakcEQNsDQO1JsYF3AwACJCRZyNZLtAmTNJBuArpkkA7BpJtoAXJqJMgCfZoIGENJMlAtobgAAxjYe/mAX2UYAAAAASUVORK5CYII="},{"name":"BG_03_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAeElEQVR4nGP0z64SZUAD57cuf4UuhgswYRM09I4UI0azoXekGFYDKHIBKZqxGoANYPMSTAzFAGy249PMwMDAwCinoPifGBfADEc3kCgv4AsXogzAB0gyAFt4EG0ArsRFdjQSbQChZI3XAGLyBF4DiEnWRCUkfK4CAPUOJpAd/9ArAAAAAElFTkSuQmCC"},{"name":"BG_03_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAiElEQVR4nGOUU1D8z4AEDL0jxc5vXf4KxmZgYGCA8bEBJpgiQ+9IMRgbHeASZ2BgYGDCJUGsIUQbQJIL8DkZqwHIAUcVF5BlALorsHkDmxhJLsDmTRQD8IXF+a3LX2FLKyzYnInNEFwxg2EAPsXYAFmxgGwB2dEIM4SidGDoHSmGNQyIAbCABgD10zCIX2Dx2gAAAABJRU5ErkJggg=="},{"name":"BG_03_06","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAXklEQVR4nGOUU1D8zwAFht6RYgxI4PzW5a/QxdABI7IB2AwhBJjQBc5vXf6KIgNINQSrARS7YNQAOhpwfuvyVzgNIJQWYPIYSRkdYMsfyHyCXkDWgM1VBF1ACFAcCwBUoyT+9r3EMgAAAABJRU5ErkJggg=="},{"name":"BG_03_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAWElEQVR4nGP0z64SZSACnN+6/JWhd6QYujgTMZrxAaINwGY7fV0wagAeA85vXf6KYhdQYgh1wgBXKiPKAEPvSDFKvMACcwGyIcS4CKaeBZsmdBehG4gsDwAqwCFtSv8sXwAAAABJRU5ErkJggg=="},{"name":"BG_03_08","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdUlEQVR4nGP0z64SZSASnN+6/BW6GBOxmnEBFnJtJtoF+DQbekeK4TWAkGYGBixewKXJ0DtSjGAgIiuA2YBuCLo43AUwzdg04nMZigtwacZnIIYX8AUcNoA1HRBryPmty19RnBKZSLERG2CUU1D8T7ELBtQAABpiOGGyjyq/AAAAAElFTkSuQmCC"},{"name":"BG_03_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAa0lEQVR4nGOUU1D8b+gdKcbAwMBwfuvyVwwMDAwwPjGAUU5B8T+MQ4pGGGAhRxMyYKJE86gBZBpwfuvyV7D0QrIByBphbJSExMCAOzEha0YGGAbADMGlgSgDSAEUxYKhd6QY2QbAworidAAAbxEj3+9CX6EAAAAASUVORK5CYII="},{"name":"BG_03_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAUUlEQVR4nGOUU1D8z4AHGHpHip3fuvwVLnkWQ+9IMVyS+DTCABMlthM0AGYIRQYQMoQoAyh2AT5X0M8FuGKDPi7AlxYIGkBxQiIEBrkBxORGALPpHJUjNhkCAAAAAElFTkSuQmCC"},{"name":"BG_03_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATklEQVR4nGOUU1D8z0AEMPSOFMMmzkSJZqINwAeGgAH4/E8fF1BkACHn094FNDfg/Nblr/AacH7r8leEDGHBJ4ktENENZSQ2N+ICFAciAOAIELM9BBPuAAAAAElFTkSuQmCC"},{"name":"BG_03_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAb0lEQVR4nGP0z64SZUAC57cufwVjG3pHijEQAEyUaEYxgBzNDAwMDCzEKkQHMAtZSLUdphamjigXoFuAzMcwAFkSl6tghhh6R4phGEBsAMIMYSI39GGAibAS/K6gyACKXUB9A7BFIckuINUQir0AADXqOIivTAztAAAAAElFTkSuQmCC"},{"name":"BG_03_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAi0lEQVR4nGP0z64SZWBgYDi/dfkrQ+9IMQY0cH7r8lfoYgwMDAwwtSz4NOMDMIOZyNGMDJhI0czGyc2IYQAhTcgW/Pr+9b+hd6QYshgLsbZjAYhAJAWgxwpBLxAClBuAK6HAACF5JkPvSDFcighpZmCAegGbIcRoZmBAigV8LiHoAmRDKDKAHECxAQBOTTicoeHtHwAAAABJRU5ErkJggg=="},{"name":"BG_03_14","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAh0lEQVR4nGP0z64SZWBgYDi/dfkrBiRg6B0pxoAFnN+6/BVM7vzW5a9Y0DWSCpgo0WzoHSmG0wBsLkN2Pgwwyiko/ifGJmyaGRiI9AK+cCI6DGCuQDeMaC/gchFBA3ClBxigKBoJGkDIdrwGEKMZpwHEaj6/dfkrDAOI1YzTBaRmLrLSAbJFAPW4Pt/AZvz9AAAAAElFTkSuQmCC"},{"name":"BG_03_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAh0lEQVR4nKVSwRGAMAijnDP49HQE53ACJ2SCztE9uoS+6FUOkGqeNAkpl7Ss2wUAsB/nDAIlU+V5yVT7N55PmkiSNLB54gRRkeRiVGwB3yk2SqaK/VYZUZJDCTwT1UATjJjgl8OZCax7eIkePbBa5ybQhiPfagZSFDVxixQx+dXEZmBtihzzBocNRSUv38UpAAAAAElFTkSuQmCC"},{"name":"BG_03_16","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYUlEQVR4nGP0z64SZaAAMFGiedQAqAHnty5/RYkBjHIKiv9hHEPvSDGSXUCJ7QwMDAws5GqEeZ0sFyCHG0oYMDDgDwdsAY5hADZDsGmEqcHqBWQNhKIZZyASmz7IjkaYBQBcGyTtmLrNPQAAAABJRU5ErkJggg=="},{"name":"BG_03_17","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYklEQVR4nGP0z64SZaAAMFGiedSAwWDA+a3LX7Egc7ApMvSOFMNnCKOcguJ/QjbhMuT81uWviPICLtcxMCCFgaF3pBgh52I1AF0TPudi4zPBNOFzJj7DWPBJEiPHREgBIQAAJecrHu1EsToAAAAASUVORK5CYII="},{"name":"BG_03_18","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAe0lEQVR4nGP0z64SZcADzm9d/gqbuKF3pBgDAwMDCz7NxBiM0wBcNiPbzsDAwMBEiWasBpCimYEB6gV8AYXPQAYGBgYmZAXYbDD0jhTDJo7iAlwKCNnOwMDAwITPdGIMZDq/dfkrYmzCBRjlFBT/k6uZgQFHOhg1gDQAAGGTMPi/lXEgAAAAAElFTkSuQmCC"},{"name":"BG_04_00","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAXUlEQVR4nGOUU1D8z8DAwGDoHSnGgAOc37r8laF3pNj5rctfocsx4dKErhmXPCPMBeiugNkGE8NmOwMDAwMLum3YDMMHcHoB2TBctjMwoHmBHEAwEEcNGDWALgYAAM3+ImTUcCzAAAAAAElFTkSuQmCC"},{"name":"BG_04_01","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASklEQVR4nGOUU1D8z0ABYCJFsaF3pJihd6QYshgjIRega4CB81uXvyLoAlyakQFJXqCaATDnMzCQGAbIGok2gBAYmDAYNWCwGQAAkTwTa+5ju0gAAAAASUVORK5CYII="},{"name":"BG_04_02","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANklEQVR4nGOUU1D8z4ADGHpHip3fuvwVjI1NDSM+A7AZCGPDDCbJAGyAiRLNowaMGjBqAAIAAHvfDSOBW8v8AAAAAElFTkSuQmCC"},{"name":"BG_04_03","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAVUlEQVR4nGP0z64SZcABzm9d/gqXHAwwkaLZ0DtSzNA7UgxZjFFOQfG/oXekGCHb0DXC1DMR41R0zcgApxeIBUQZgO5CZD6jnILif5q7YNSAUQMIAQCA1h5Nl1St9gAAAABJRU5ErkJggg=="},{"name":"BG_04_04","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAM0lEQVR4nGOUU1D8z0AiMPSOFIOxmUjVzMDAwHB+6/JXMDYjOS5ABmS5YNSAUQNGDcAEAEEuBts19RvyAAAAAElFTkSuQmCC"},{"name":"BG_04_05","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAR0lEQVR4nGP0z64SZSARnN+6/BWMzYJP0tA7UgyfPAMDAwMTPsnzW5e/QhZDl2dgYGBglFNQ/E+s07EBJsJKRg0YNWBEGAAANfwZRgTMpiIAAAAASUVORK5CYII="},{"name":"BG_04_07","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASElEQVR4nGP0z64SZSAAzm9d/gqXHBMhzQwMDAyG3pFiOA3AZzoxLmCUU1D8j88mQhageAFdMTGuQ3EBOYCoQBw1YNQAmhsAAJMXGHdAwnEGAAAAAElFTkSuQmCC"},{"name":"BG_04_09","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAK0lEQVR4nGOUU1D8z0AmMPSOFGMiVzMMMFLiAgYGBgaKXTBqwKgBowZAAAAkUAPGCP7dawAAAABJRU5ErkJggg=="},{"name":"BG_04_10","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAWklEQVR4nGP0z64SZcACzm9d/srQO1Ls/Nblr7DJwwATPs34NMIAC7pGBgYGBphmQrYzMDAwsCArItZWZIDiBWTDiLGdgYGBgVFOQfE/qbbidMGoAaMGDJgBABnHHx62YreuAAAAAElFTkSuQmCC"},{"name":"BG_04_11","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASUlEQVR4nGOUU1D8z0ABYCKkwNA7UszQO1IMlzwjNhfg0nB+6/JXBF2AzzZsgKAXqGYANuczMBARBrg04jWAFEC/MBg1YDAbAAA3UxNrIq9cZAAAAABJRU5ErkJggg=="},{"name":"BG_04_12","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAPklEQVR4nGOUU1D8z4ADGHpHiuGSgwEmfJLnty5/hc5HF2PE5wJ8wNA7Uuz81uWvyDYABvB6YdSAUQNGkAEArywSYtpdMscAAAAASUVORK5CYII="},{"name":"BG_04_13","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATklEQVR4nGP0z64SZUAC57cuf8VAAmAipNnQO1LM0DtSDJcBjHIKiv9xSaJrxGYBE7oALs24AE4DiAU4DUB3Lq7AxRsGFLlg1IBRA0gBADqmFzhqAqfOAAAAAElFTkSuQmCC"},{"name":"BG_04_14","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANklEQVR4nGOUU1D8z0AEMPSOFEPmn9+6/BUDAwMDEzGakTWgsxmJdQEuQLQLRg0YNWDUAPwAAFhKDQWi00ikAAAAAElFTkSuQmCC"},{"name":"BG_04_15","b64":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAO0lEQVR4nGOUU1D8b+gdKcaABs5vXf4KXQwbYDH0jhRDVozOJwQY5RQU/xOrGBtgokTzqAGjBowagAAAoKYO3f4NRYEAAAAASUVORK5CYII="}];
const BG_TILE_COLS = 19;
const BG_TILE_ROWS = 6;


// State
let mapW = 128, mapH = 32;
const LAYER_NAMES = ["BG","Main"];
let layers = [null,null];
let curLayer = 1;
let layerVisible = [true,true];
let layerParallax = [0.5, 1.0];
let map = [];
let tileFlags = new Uint8Array(TILES.length);
let selectedTiles = [0];
let lastClickedTile = 0;
let placementMode = "single"; // "single" | "random" | "stamp"
let hoverTX = -1, hoverTY = -1;
let currentTool = "pencil";
let zoom = 1.5;
let panX = 0, panY = 0;
let showGrid = true;
let showFlagsOverlay = false;
let undoStack = [];
let redoStack = [];
let isPanning = false;
let panStartX = 0, panStartY = 0;
let panStartPanX = 0, panStartPanY = 0;
let isDrawing = false;
let drawStartTX = -1, drawStartTY = -1;
let lastDrawTX = -1, lastDrawTY = -1;
let spaceDown = false;
let tileImages = [];
let bgTileImages = [];
let bgTileLum = [];
let bgRemappedImages = [];
let activePalette = "main"; // "main" or "bg"
let palTileSize = 40;
let selection = null;       // {x, y, w, h} in tile coords, or null
let selDragStart = null;    // {x, y} while dragging new selection
let clipboard = null;       // {w, h, tiles:[][], xforms:[][]} or null
let isMovingSelection = false;
let moveDragStart = null;   // {x, y} tile where move drag began
let spawnX = -1, spawnY = -1; // tile coords, -1 = not set

let mapXform = [];
let curRotation = 0; // 0-3 (0Â°, 90Â°, 180Â°, 270Â°)
let curHFlip = false;
let curVFlip = false;

function packXform() { return curRotation | (curHFlip ? 4 : 0) | (curVFlip ? 8 : 0); }
function unpackXform(v) { return { rot: v & 3, hflip: !!(v & 4), vflip: !!(v & 8) }; }
function getSelectedTile() { return selectedTiles[0] || 0; }
function getRandomTile() { return selectedTiles[Math.floor(Math.random() * selectedTiles.length)]; }
function getTileForPlacement() { if (placementMode === "random" && selectedTiles.length > 1) return getRandomTile(); return getSelectedTile(); }
function getStampTiles() {
  if (selectedTiles.length <= 1) return [{dx:0, dy:0, idx: getSelectedTile()}];
  const curTiles = activePalette === "bg" ? BG_TILES : TILES;
  const re = activePalette === "bg" ? /BG_(\d+)_(\d+)/ : /T_(\d+)_(\d+)/;
  const positions = selectedTiles.map(i => { const m = curTiles[i].name.match(re); return m ? {r: parseInt(m[1]), c: parseInt(m[2]), idx: i} : null; }).filter(Boolean);
  if (!positions.length) return [{dx:0, dy:0, idx: getSelectedTile()}];
  const minR = Math.min(...positions.map(p=>p.r)), minC = Math.min(...positions.map(p=>p.c));
  return positions.map(p => ({dx: p.c - minC, dy: p.r - minR, idx: p.idx}));
}
function updateModeButtons() {
  const multi = selectedTiles.length > 1;
  document.getElementById("mode-random").classList.toggle("active", placementMode === "random");
  document.getElementById("mode-stamp").classList.toggle("active", placementMode === "stamp");
  document.getElementById("mode-random").style.opacity = multi ? "1" : "0.4";
  document.getElementById("mode-stamp").style.opacity = multi ? "1" : "0.4";
}
function setPlacementMode(m) { placementMode = m; updateModeButtons(); document.getElementById("st-mode").textContent = "Mode: " + m; }
// Tileset helpers: return the correct tileset arrays for a given layer
function tilesetForLayer(L) { return L === 0 ? BG_TILES : TILES; }
function imagesForLayer(L) { return L === 0 ? bgRemappedImages : remappedImages; }
function rawImagesForLayer(L) { return L === 0 ? bgTileImages : tileImages; }
function paletteForLayer(L) { return L === 0 ? "bg" : "main"; }
function updateXformStatus() {
  const parts = [];
  if (curRotation > 0) parts.push(curRotation * 90 + "\u00b0");
  if (curHFlip) parts.push("H");
  if (curVFlip) parts.push("V");
  document.getElementById("st-xform").textContent = "Xform: " + (parts.length ? parts.join(" ") : "none");
}
function clearSelection() { selection = null; selDragStart = null; isMovingSelection = false; moveDragStart = null; }
function inSelection(tx, ty) { if (!selection) return false; return tx >= selection.x && tx < selection.x + selection.w && ty >= selection.y && ty < selection.y + selection.h; }
function copySelection() {
  if (!selection) return;
  const s = selection;
  const tiles = [], xforms = [];
  for (let y = 0; y < s.h; y++) {
    const tr = new Uint8Array(s.w), xr = new Uint8Array(s.w);
    for (let x = 0; x < s.w; x++) {
      const my = s.y + y, mx = s.x + x;
      if (my >= 0 && my < mapH && mx >= 0 && mx < mapW) { tr[x] = map[my][mx]; xr[x] = mapXform[my][mx]; }
      else { tr[x] = 255; xr[x] = 0; }
    }
    tiles.push(tr); xforms.push(xr);
  }
  clipboard = { w: s.w, h: s.h, tiles, xforms };
  showToast(`Copied ${s.w}Ã—${s.h} tiles`);
}
let _toastTimer = null;
function showToast(msg) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove("show"), 1200);
}
function clearSelectionArea() {
  if (!selection) return;
  const s = selection;
  pushUndo();
  for (let y = 0; y < s.h; y++) for (let x = 0; x < s.w; x++) {
    const my = s.y + y, mx = s.x + x;
    if (my >= 0 && my < mapH && mx >= 0 && mx < mapW) { map[my][mx] = 255; mapXform[my][mx] = 0; }
  }
  render();
}
function pasteClipboard(tx, ty) {
  if (!clipboard) return;
  pushUndo();
  for (let y = 0; y < clipboard.h; y++) for (let x = 0; x < clipboard.w; x++) {
    const my = ty + y, mx = tx + x;
    if (my >= 0 && my < mapH && mx >= 0 && mx < mapW) { map[my][mx] = clipboard.tiles[y][x]; mapXform[my][mx] = clipboard.xforms[y][x]; }
  }
  selection = { x: tx, y: ty, w: clipboard.w, h: clipboard.h };
  render();
}

// PICO-8 palette
const P8_HEX = ["#000000","#1d2b53","#7e2553","#008751","#ab5236","#5f574f","#c2c3c7","#fff1e8","#ff004d","#ffa300","#ffec27","#00e436","#29adff","#83769c","#ff77a8","#ffccaa"];
const P8_RGB = P8_HEX.map(h => [parseInt(h.slice(1,3),16), parseInt(h.slice(3,5),16), parseInt(h.slice(5,7),16)]);

// Luminance bands: [label, minLum, maxLum, defaultP8color]
const BANDS = [
  ["Black",    0,  20,  0],
  ["Dk Grey", 21,  45,  5],
  ["Mid Grey",46, 100, 13],
  ["Lt Grey",101, 185,  6],
  ["White",   186, 255,  7],
];
let bandColors = BANDS.map(b => b[3]); // current P8 color per band
let tileLum = []; // per tile: array of {lum, alpha} per pixel

function _extractLum(tiles, images) {
  const tmp = document.createElement("canvas"); tmp.width = 16; tmp.height = 16;
  const tctx = tmp.getContext("2d");
  const lums = [];
  tiles.forEach((t, i) => {
    tctx.clearRect(0,0,16,16);
    tctx.drawImage(images[i], 0, 0);
    const d = tctx.getImageData(0,0,16,16).data;
    const arr = [];
    for (let p = 0; p < d.length; p += 4) {
      const lum = Math.round(0.299*d[p] + 0.587*d[p+1] + 0.114*d[p+2]);
      arr.push({ lum, a: d[p+3] });
    }
    lums[i] = arr;
  });
  return lums;
}
function extractTileLuminance() {
  tileLum = _extractLum(TILES, tileImages);
  bgTileLum = _extractLum(BG_TILES, bgTileImages);
}

function lumToBand(lum) {
  for (let b = 0; b < BANDS.length; b++) {
    if (lum >= BANDS[b][1] && lum <= BANDS[b][2]) return b;
  }
  return BANDS.length - 1;
}

// Rebuild tile image canvases with current band mapping
let remappedImages = []; // canvas elements
function _remapTiles(tiles, lumArr) {
  const out = [];
  tiles.forEach((t, i) => {
    const c = document.createElement("canvas"); c.width = 16; c.height = 16;
    const ctx2 = c.getContext("2d");
    const img = ctx2.createImageData(16, 16);
    const lums = lumArr[i];
    for (let p = 0; p < lums.length; p++) {
      if (lums[p].a === 0) { img.data[p*4+3] = 0; continue; }
      const band = lumToBand(lums[p].lum);
      const col = P8_RGB[bandColors[band]];
      img.data[p*4] = col[0]; img.data[p*4+1] = col[1]; img.data[p*4+2] = col[2]; img.data[p*4+3] = lums[p].a;
    }
    ctx2.putImageData(img, 0, 0);
    out[i] = c;
  });
  return out;
}
function remapAllTiles() {
  remappedImages = _remapTiles(TILES, tileLum);
  bgRemappedImages = _remapTiles(BG_TILES, bgTileLum);
}

function refreshPaletteTiles() {
  const imgs = activePalette === "bg" ? bgRemappedImages : remappedImages;
  document.querySelectorAll(".tile-btn").forEach(b => {
    const idx = parseInt(b.dataset.idx);
    const cv = b.querySelector("canvas");
    if (cv && imgs[idx]) { cv.getContext("2d").clearRect(0,0,16,16); cv.getContext("2d").drawImage(imgs[idx], 0, 0); }
  });
}

function buildBandEditor() {
  const container = document.getElementById("band-rows");
  container.innerHTML = "";
  BANDS.forEach((band, bi) => {
    const row = document.createElement("div"); row.className = "band-row";
    const label = document.createElement("div"); label.className = "band-label";
    label.textContent = band[0];
    row.appendChild(label);
    const preview = document.createElement("div"); preview.className = "band-preview";
    preview.id = "band-preview-" + bi;
    preview.style.backgroundColor = P8_HEX[bandColors[bi]];
    row.appendChild(preview);
    const colors = document.createElement("div"); colors.className = "band-colors";
    for (let c = 0; c < 16; c++) {
      const sw = document.createElement("div"); sw.className = "band-swatch" + (c === bandColors[bi] ? " active" : "");
      sw.style.backgroundColor = P8_HEX[c]; sw.dataset.band = bi; sw.dataset.color = c;
      sw.title = c;
      sw.addEventListener("click", () => {
        bandColors[bi] = c;
        row.querySelectorAll(".band-swatch").forEach(s => s.classList.toggle("active", parseInt(s.dataset.color) === c));
        document.getElementById("band-preview-" + bi).style.backgroundColor = P8_HEX[c];
        remapAllTiles(); refreshPaletteTiles(); render();
      });
      colors.appendChild(sw);
    }
    row.appendChild(colors);
    container.appendChild(row);
  });
}

function makeEmptyLayer() {
  const m = [], x = [];
  for (let y = 0; y < mapH; y++) { m.push(new Uint8Array(mapW).fill(255)); x.push(new Uint8Array(mapW)); }
  return {map: m, xform: x};
}
function initMap() {
  for (let i = 0; i < 2; i++) layers[i] = makeEmptyLayer();
  map = layers[curLayer].map;
  mapXform = layers[curLayer].xform;
}
function switchLayer(L) {
  curLayer = L;
  map = layers[L].map;
  mapXform = layers[L].xform;
  switchPaletteTab(paletteForLayer(L));
  updateLayerUI();
  render();
}
function updateLayerUI() {
  document.querySelectorAll(".layer-btn").forEach((b, i) => {
    b.classList.toggle("active", i === curLayer);
  });
}
function switchPaletteTab(tab) {
  if (tab === activePalette) return;
  activePalette = tab;
  selectedTiles = [0];
  lastClickedTile = 0;
  if (placementMode !== "single") setPlacementMode("single");
  document.querySelectorAll(".pal-tab").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
  buildPalette();
}

function loadTileImages(cb) {
  const total = TILES.length + BG_TILES.length;
  let loaded = 0;
  function onLoad() { loaded++; if (loaded === total) cb(); }
  TILES.forEach((t, i) => {
    const img = new Image();
    img.onload = onLoad;
    img.src = "data:image/png;base64," + t.b64;
    tileImages[i] = img;
  });
  BG_TILES.forEach((t, i) => {
    const img = new Image();
    img.onload = onLoad;
    img.src = "data:image/png;base64," + t.b64;
    bgTileImages[i] = img;
  });
}

// Palette
function buildPalette() {
  const pal = document.getElementById("palette");
  pal.innerHTML = "";
  if (activePalette === "bg") {
    buildBGPalette(pal);
  } else {
    buildMainPalette(pal);
  }
}
function buildMainPalette(pal) {
  const posMap = {};
  TILES.forEach((t, i) => { const m = t.name.match(/T_(\d+)_(\d+)/); if (m) posMap[m[1]+"_"+m[2]] = i; });
  const COLS = 18, ROWS = 16;
  const grid = document.createElement("div"); grid.className = "tile-grid";
  grid.style.gridTemplateColumns = `repeat(${COLS}, ${palTileSize}px)`;
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const key = String(r).padStart(2,"0") + "_" + String(c).padStart(2,"0");
      const i = posMap[key];
      if (i !== undefined) {
        const btn = document.createElement("div");
        btn.className = "tile-btn" + (selectedTiles.includes(i) ? " selected" : "");
        btn.dataset.idx = i; btn.title = TILES[i].name;
        const cv = document.createElement("canvas"); cv.width = 16; cv.height = 16;
        cv.getContext("2d").drawImage(remappedImages[i] || tileImages[i], 0, 0);
        btn.appendChild(cv);
        const flag = document.createElement("div"); flag.className = "tile-flag";
        flag.textContent = tileFlags[i];
        flag.style.display = tileFlags[i] > 0 ? "" : "none";
        btn.appendChild(flag);
        btn.addEventListener("click", (e) => selectTile(i, {ctrl: e.ctrlKey || e.metaKey, shift: e.shiftKey}));
        grid.appendChild(btn);
      } else {
        const spacer = document.createElement("div"); spacer.className = "tile-spacer";
        grid.appendChild(spacer);
      }
    }
  }
  pal.appendChild(grid);
}
function buildBGPalette(pal) {
  const posMap = {};
  BG_TILES.forEach((t, i) => { const m = t.name.match(/BG_(\d+)_(\d+)/); if (m) posMap[m[1]+"_"+m[2]] = i; });
  const grid = document.createElement("div"); grid.className = "tile-grid";
  grid.style.gridTemplateColumns = `repeat(${BG_TILE_COLS}, ${palTileSize}px)`;
  for (let r = 0; r < BG_TILE_ROWS; r++) {
    for (let c = 0; c < BG_TILE_COLS; c++) {
      const key = String(r).padStart(2,"0") + "_" + String(c).padStart(2,"0");
      const i = posMap[key];
      if (i !== undefined) {
        const btn = document.createElement("div");
        btn.className = "tile-btn" + (selectedTiles.includes(i) ? " selected" : "");
        btn.dataset.idx = i; btn.title = BG_TILES[i].name;
        const cv = document.createElement("canvas"); cv.width = 16; cv.height = 16;
        cv.getContext("2d").drawImage(bgRemappedImages[i] || bgTileImages[i], 0, 0);
        btn.appendChild(cv);
        btn.addEventListener("click", (e) => selectTile(i, {ctrl: e.ctrlKey || e.metaKey, shift: e.shiftKey}));
        grid.appendChild(btn);
      } else {
        const spacer = document.createElement("div"); spacer.className = "tile-spacer";
        grid.appendChild(spacer);
      }
    }
  }
  pal.appendChild(grid);
}

function tileGridPos(idx, tiles) {
  const re = activePalette === "bg" ? /BG_(\d+)_(\d+)/ : /T_(\d+)_(\d+)/;
  const m = tiles[idx].name.match(re);
  return m ? {r: parseInt(m[1]), c: parseInt(m[2])} : null;
}
function selectTile(i, opts) {
  const ctrl = opts && opts.ctrl;
  const shift = opts && opts.shift;
  const curTiles = activePalette === "bg" ? BG_TILES : TILES;
  if (shift && lastClickedTile >= 0) {
    const posA = tileGridPos(lastClickedTile, curTiles);
    const posB = tileGridPos(i, curTiles);
    if (posA && posB) {
      const r0 = Math.min(posA.r, posB.r), r1 = Math.max(posA.r, posB.r);
      const c0 = Math.min(posA.c, posB.c), c1 = Math.max(posA.c, posB.c);
      const re = activePalette === "bg" ? /BG_(\d+)_(\d+)/ : /T_(\d+)_(\d+)/;
      selectedTiles = [];
      curTiles.forEach((t, idx) => {
        const m = t.name.match(re);
        if (m) {
          const r = parseInt(m[1]), c = parseInt(m[2]);
          if (r >= r0 && r <= r1 && c >= c0 && c <= c1) selectedTiles.push(idx);
        }
      });
    }
    lastClickedTile = i;
  } else if (ctrl) {
    const idx = selectedTiles.indexOf(i);
    if (idx >= 0 && selectedTiles.length > 1) selectedTiles.splice(idx, 1);
    else if (idx < 0) selectedTiles.push(i);
    lastClickedTile = i;
  } else {
    selectedTiles = [i];
    lastClickedTile = i;
  }
  if (selectedTiles.length <= 1 && placementMode !== "single") setPlacementMode("single");
  if (selectedTiles.length > 1 && placementMode === "single") setPlacementMode("random");
  updateModeButtons();
  document.querySelectorAll(".tile-btn").forEach(b => b.classList.toggle("selected", selectedTiles.includes(parseInt(b.dataset.idx))));
  updateFlagEditor();
  if (selectedTiles.length === 1) document.getElementById("st-tile").textContent = "Tile: " + curTiles[selectedTiles[0]].name;
  else document.getElementById("st-tile").textContent = "Tiles: " + selectedTiles.length + " selected";
}

function updateFlagEditor() {
  if (selectedTiles.length>1) {
    document.getElementById("flag-tile-name").textContent = selectedTiles.length+" tiles";
  } else {
    const curTiles = activePalette === "bg" ? BG_TILES : TILES;
    document.getElementById("flag-tile-name").textContent = curTiles[getSelectedTile()].name;
  }
  document.querySelectorAll("#flag-buttons button").forEach(b => {
    const bit = parseInt(b.dataset.val);
    const mask = 1 << bit;
    // active if ALL selected tiles have this flag set
    const allSet = selectedTiles.every(ti => (tileFlags[ti] & mask) !== 0);
    b.classList.toggle("active", allSet);
  });
}

function buildFlagButtons() {
  const container = document.getElementById("flag-buttons");
  for (let i = 0; i < 8; i++) {
    const btn = document.createElement("button"); btn.textContent = i; btn.dataset.val = i;
    btn.addEventListener("click", () => {
      const mask = 1 << i;
      // if all selected have it, clear; otherwise set
      const allSet = selectedTiles.every(ti => (tileFlags[ti] & mask) !== 0);
      for (const ti of selectedTiles) {
        if (allSet) tileFlags[ti] &= ~mask;
        else tileFlags[ti] |= mask;
      }
      updateFlagEditor(); updatePaletteFlags(); render();
    });
    container.appendChild(btn);
  }
}

function flagsLabel(f) {
  if (f === 0) return "";
  const bits = [];
  for (let i = 0; i < 8; i++) if (f & (1 << i)) bits.push(i);
  return bits.join(",");
}

function updateSpawnInfo() {
  document.getElementById("spawn-info").textContent = (spawnX>=0&&spawnY>=0) ? `Spawn: ${spawnX},${spawnY}` : "Spawn: not set";
}

function updatePaletteFlags() {
  document.querySelectorAll(".tile-btn").forEach(b => {
    const idx = parseInt(b.dataset.idx); const flag = b.querySelector(".tile-flag");
    const f = tileFlags[idx];
    flag.textContent = flagsLabel(f);
    flag.style.display = f > 0 ? "" : "none";
  });
}

// Canvas
const canvas = document.getElementById("map-canvas");
const ctx = canvas.getContext("2d");

let _memTimer = null;
function scheduleMemEstimate() {
  if (_memTimer) clearTimeout(_memTimer);
  _memTimer = setTimeout(updateMemEstimate, 300);
}

function render() {
  scheduleMemEstimate();
  const ts = 16 * zoom;
  canvas.width = mapW * ts; canvas.height = mapH * ts;
  canvas.style.left = panX + "px"; canvas.style.top = panY + "px";
  ctx.imageSmoothingEnabled = false;
  ctx.fillStyle = "#2a2a3a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
  for (let L = 0; L < 2; L++) {
    if (!layerVisible[L]) continue;
    const lm = layers[L].map, lx = layers[L].xform;
    const lImgs = imagesForLayer(L), lRaw = rawImagesForLayer(L);
    for (let y = 0; y < mapH; y++) for (let x = 0; x < mapW; x++) {
      const ti = lm[y][x];
      if (ti !== 255) {
        const xf = unpackXform(lx[y][x]);
        const img = lImgs[ti] || lRaw[ti];
        if (!img) continue;
        if (xf.rot === 0 && !xf.hflip && !xf.vflip) {
          ctx.drawImage(img, x*ts, y*ts, ts, ts);
        } else {
          ctx.save();
          ctx.translate(x*ts + ts/2, y*ts + ts/2);
          if (xf.hflip) ctx.scale(-1, 1);
          if (xf.vflip) ctx.scale(1, -1);
          ctx.rotate(xf.rot * Math.PI / 2);
          ctx.drawImage(img, -ts/2, -ts/2, ts, ts);
          ctx.restore();
        }
      }
    }
    // dim inactive layers
    if (L !== curLayer) {
      ctx.fillStyle = "rgba(0,0,20,0.4)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    // draw spawn marker after main layer
    if (L === 1 && spawnX >= 0 && spawnY >= 0) {
      const sx = spawnX * ts, sy = spawnY * ts;
      ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2;
      ctx.strokeRect(sx+1, sy+1, ts-2, ts*3-2);
      ctx.fillStyle = "rgba(0,255,0,0.2)"; ctx.fillRect(sx+1, sy+1, ts-2, ts*3-2);
      ctx.fillStyle = "#0f0"; ctx.font = Math.max(8, ts*0.4) + "px monospace";
      ctx.textAlign = "center"; ctx.textBaseline = "bottom";
      ctx.fillText("SPAWN", sx+ts/2, sy-2);
    }
  }
  if (showGrid) {
    ctx.strokeStyle = "rgba(255,255,255,0.12)"; ctx.lineWidth = 1;
    for (let x = 0; x <= mapW; x++) { ctx.beginPath(); ctx.moveTo(x*ts+0.5,0); ctx.lineTo(x*ts+0.5,canvas.height); ctx.stroke(); }
    for (let y = 0; y <= mapH; y++) { ctx.beginPath(); ctx.moveTo(0,y*ts+0.5); ctx.lineTo(canvas.width,y*ts+0.5); ctx.stroke(); }
  }
  if (showFlagsOverlay) {
    ctx.font = Math.max(7, ts*0.35) + "px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
    for (let y = 0; y < mapH; y++) for (let x = 0; x < mapW; x++) {
      const ti = map[y][x];
      if (ti !== 255 && tileFlags[ti] > 0) {
        ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(x*ts, y*ts, ts, ts);
        ctx.fillStyle = "#ff0"; ctx.fillText(flagsLabel(tileFlags[ti]), x*ts+ts/2, y*ts+ts/2);
      }
    }
  }
  // Selection overlay
  if (selection) {
    const s = selection;
    ctx.save();
    ctx.strokeStyle = "#29adff"; ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    ctx.strokeRect(s.x * ts + 1, s.y * ts + 1, s.w * ts - 2, s.h * ts - 2);
    ctx.fillStyle = "rgba(41,173,255,0.12)";
    ctx.fillRect(s.x * ts, s.y * ts, s.w * ts, s.h * ts);
    ctx.setLineDash([]);
    ctx.restore();
  }
  // Ghost preview
  if (hoverTX >= 0 && hoverTY >= 0 && currentTool !== "select" && currentTool !== "spawn" && !isDrawing) {
    ctx.save();
    ctx.globalAlpha = 0.45;
    const gImgs = imagesForLayer(curLayer), gRaw = rawImagesForLayer(curLayer);
    const xf = {rot: curRotation, hflip: curHFlip, vflip: curVFlip};
    if (placementMode === "stamp" && selectedTiles.length > 1) {
      const stamp = getStampTiles();
      stamp.forEach(s => {
        const gx = hoverTX + s.dx, gy = hoverTY + s.dy;
        if (gx >= 0 && gx < mapW && gy >= 0 && gy < mapH) {
          const img = gImgs[s.idx] || gRaw[s.idx];
          if (!img) return;
          if (xf.rot === 0 && !xf.hflip && !xf.vflip) { ctx.drawImage(img, gx*ts, gy*ts, ts, ts); }
          else { ctx.save(); ctx.translate(gx*ts+ts/2, gy*ts+ts/2); if(xf.hflip)ctx.scale(-1,1); if(xf.vflip)ctx.scale(1,-1); ctx.rotate(xf.rot*Math.PI/2); ctx.drawImage(img,-ts/2,-ts/2,ts,ts); ctx.restore(); }
        }
      });
    } else {
      const ti = getSelectedTile();
      const img = gImgs[ti] || gRaw[ti];
      if (img) {
        if (xf.rot === 0 && !xf.hflip && !xf.vflip) { ctx.drawImage(img, hoverTX*ts, hoverTY*ts, ts, ts); }
        else { ctx.save(); ctx.translate(hoverTX*ts+ts/2, hoverTY*ts+ts/2); if(xf.hflip)ctx.scale(-1,1); if(xf.vflip)ctx.scale(1,-1); ctx.rotate(xf.rot*Math.PI/2); ctx.drawImage(img,-ts/2,-ts/2,ts,ts); ctx.restore(); }
      }
    }
    ctx.restore();
  }
  updateStatus();
}

function updateStatus() {
  document.getElementById("st-zoom").textContent = "Zoom: " + zoom.toFixed(1) + "x";
  document.getElementById("st-size").textContent = "Map: " + mapW + "x" + mapH + " (" + (mapW*mapH) + " cells)";
}

function screenToTile(sx, sy) {
  const wrap = document.getElementById("canvas-wrap"); const rect = wrap.getBoundingClientRect();
  const ts = 16 * zoom;
  return [Math.floor((sx - rect.left - panX) / ts), Math.floor((sy - rect.top - panY) / ts)];
}

function inBounds(tx, ty) { return tx >= 0 && tx < mapW && ty >= 0 && ty < mapH; }

// Undo/Redo
function pushUndo() {
  const snap = layers.map(L => ({map: L.map.map(r => new Uint8Array(r)), xform: L.xform.map(r => new Uint8Array(r))}));
  undoStack.push(snap);
  if (undoStack.length > 100) undoStack.shift();
  redoStack = [];
}
function undo() {
  if (!undoStack.length) return;
  redoStack.push(layers.map(L => ({map: L.map.map(r => new Uint8Array(r)), xform: L.xform.map(r => new Uint8Array(r))})));
  const s = undoStack.pop();
  for (let i = 0; i < 2; i++) layers[i] = s[i];
  map = layers[curLayer].map; mapXform = layers[curLayer].xform;
  mapH = map.length; mapW = map[0].length;
  render();
}
function redo() {
  if (!redoStack.length) return;
  undoStack.push(layers.map(L => ({map: L.map.map(r => new Uint8Array(r)), xform: L.xform.map(r => new Uint8Array(r))})));
  const s = redoStack.pop();
  for (let i = 0; i < 2; i++) layers[i] = s[i];
  map = layers[curLayer].map; mapXform = layers[curLayer].xform;
  mapH = map.length; mapW = map[0].length;
  render();
}

// Drawing
function setTileAt(tx, ty, val, xf) { if (inBounds(tx, ty)) { map[ty][tx] = val; mapXform[ty][tx] = (val === 255) ? 0 : (xf || 0); } }

function drawLine(x0, y0, x1, y1, val, xf) {
  const dx = Math.abs(x1-x0), dy = Math.abs(y1-y0), sx = x0<x1?1:-1, sy = y0<y1?1:-1;
  let err = dx - dy;
  while (true) { const v = (placementMode==="random"&&selectedTiles.length>1&&val!==255) ? getRandomTile() : val; setTileAt(x0,y0,v,xf); if (x0===x1&&y0===y1) break; const e2=2*err; if (e2>-dy){err-=dy;x0+=sx;} if (e2<dx){err+=dx;y0+=sy;} }
}

function floodFill(tx, ty, newVal, xf) {
  if (!inBounds(tx,ty)) return; const oldVal = map[ty][tx]; if (oldVal===newVal&&placementMode!=="random") return;
  const stack = [[tx,ty]]; const visited = new Set();
  while (stack.length) { const [x,y] = stack.pop(); const key=y*mapW+x; if (visited.has(key)||!inBounds(x,y)||map[y][x]!==oldVal) continue; visited.add(key); const v = (placementMode==="random"&&selectedTiles.length>1) ? getRandomTile() : newVal; map[y][x]=v; mapXform[y][x]=(v===255)?0:(xf||0); stack.push([x-1,y],[x+1,y],[x,y-1],[x,y+1]); }
}

function fillRect(x0,y0,x1,y1,val,xf) {
  const minX=Math.max(0,Math.min(x0,x1)),maxX=Math.min(mapW-1,Math.max(x0,x1)),minY=Math.max(0,Math.min(y0,y1)),maxY=Math.min(mapH-1,Math.max(y0,y1));
  for (let y=minY;y<=maxY;y++) for (let x=minX;x<=maxX;x++) { map[y][x]=val; mapXform[y][x]=(val===255)?0:(xf||0); }
}

// Mouse
const wrap = document.getElementById("canvas-wrap");
wrap.addEventListener("mousedown", e => {
  e.preventDefault(); const [tx,ty] = screenToTile(e.clientX, e.clientY);
  if (e.button===1||e.button===2||(e.button===0&&spaceDown)) { isPanning=true;panStartX=e.clientX;panStartY=e.clientY;panStartPanX=panX;panStartPanY=panY;wrap.style.cursor="grabbing";return; }
  if (e.altKey&&e.button===0) {
    if (inBounds(tx,ty)&&map[ty][tx]!==255) {
      selectTile(map[ty][tx], {});
      const xf = unpackXform(mapXform[ty][tx]);
      curRotation = xf.rot; curHFlip = xf.hflip; curVFlip = xf.vflip;
      updateXformStatus();
    }
    return;
  }
  if (e.button===0&&currentTool==="select") {
    if (selection && inSelection(tx, ty)) {
      isMovingSelection = true; moveDragStart = {x: tx, y: ty};
    } else {
      clearSelection(); selDragStart = {x: tx, y: ty}; selection = {x: tx, y: ty, w: 1, h: 1};
    }
    render(); return;
  }
  if (e.button===0&&currentTool==="spawn") {
    if (inBounds(tx,ty)) { spawnX=tx; spawnY=ty; updateSpawnInfo(); render(); }
    return;
  }
  if (e.button===0) {
    isDrawing=true;drawStartTX=tx;drawStartTY=ty;lastDrawTX=tx;lastDrawTY=ty;
    if (currentTool==="pencil"||currentTool==="eraser") {
      pushUndo();
      if (currentTool==="eraser") { setTileAt(tx,ty,255,0); }
      else if (placementMode==="stamp"&&selectedTiles.length>1) { const stamp=getStampTiles(); stamp.forEach(s=>setTileAt(tx+s.dx,ty+s.dy,s.idx,packXform())); }
      else { setTileAt(tx,ty,getTileForPlacement(),packXform()); }
      render();
    }
    else if (currentTool==="fill") { pushUndo();floodFill(tx,ty,currentTool==="eraser"?255:getTileForPlacement(),currentTool==="eraser"?0:packXform());render(); }
  }
});
wrap.addEventListener("mousemove", e => {
  const [tx,ty] = screenToTile(e.clientX, e.clientY);
  if (isPanning) { panX=panStartPanX+(e.clientX-panStartX);panY=panStartPanY+(e.clientY-panStartY);canvas.style.left=panX+"px";canvas.style.top=panY+"px";return; }
  if (currentTool==="select" && selDragStart && !isMovingSelection) {
    const x0 = Math.min(selDragStart.x, tx), y0 = Math.min(selDragStart.y, ty);
    const x1 = Math.max(selDragStart.x, tx), y1 = Math.max(selDragStart.y, ty);
    selection = {x: x0, y: y0, w: x1-x0+1, h: y1-y0+1};
    render(); return;
  }
  if (isMovingSelection && moveDragStart && selection) {
    const dx = tx - moveDragStart.x, dy = ty - moveDragStart.y;
    if (dx !== 0 || dy !== 0) {
      pushUndo();
      const s = selection;
      // Copy current tiles
      const tmpT = [], tmpX = [];
      for (let y = 0; y < s.h; y++) { const tr = new Uint8Array(s.w), xr = new Uint8Array(s.w); for (let x = 0; x < s.w; x++) { const my=s.y+y, mx=s.x+x; if(my>=0&&my<mapH&&mx>=0&&mx<mapW){tr[x]=map[my][mx];xr[x]=mapXform[my][mx];}else{tr[x]=255;xr[x]=0;}} tmpT.push(tr);tmpX.push(xr); }
      // Clear old area
      for (let y = 0; y < s.h; y++) for (let x = 0; x < s.w; x++) { const my=s.y+y,mx=s.x+x; if(my>=0&&my<mapH&&mx>=0&&mx<mapW){map[my][mx]=255;mapXform[my][mx]=0;} }
      // Place at new position
      const nx = s.x+dx, ny = s.y+dy;
      for (let y = 0; y < s.h; y++) for (let x = 0; x < s.w; x++) { const my=ny+y,mx=nx+x; if(my>=0&&my<mapH&&mx>=0&&mx<mapW){map[my][mx]=tmpT[y][x];mapXform[my][mx]=tmpX[y][x];} }
      selection = {x: nx, y: ny, w: s.w, h: s.h};
      moveDragStart = {x: tx, y: ty};
      render();
    }
    return;
  }
  if (isDrawing&&(currentTool==="pencil"||currentTool==="eraser")) {
    if (currentTool==="eraser") { drawLine(lastDrawTX,lastDrawTY,tx,ty,255,0); }
    else if (placementMode==="stamp"&&selectedTiles.length>1) { const stamp=getStampTiles(); stamp.forEach(s=>setTileAt(tx+s.dx,ty+s.dy,s.idx,packXform())); }
    else { drawLine(lastDrawTX,lastDrawTY,tx,ty,getTileForPlacement(),packXform()); }
    lastDrawTX=tx;lastDrawTY=ty;render();
  }
  if (inBounds(tx,ty)) { const ti=map[ty][tx]; const tn=tilesetForLayer(curLayer); document.getElementById("st-pos").textContent="x:"+tx+" y:"+ty+" ["+(ti!==255&&tn[ti]?tn[ti].name:"empty")+"]"; }
  else document.getElementById("st-pos").textContent="-";
  hoverTX = tx; hoverTY = ty;
  if (!isPanning && !isDrawing && currentTool !== "select") render();
});
wrap.addEventListener("mouseup", e => {
  if (isPanning) { isPanning=false;wrap.style.cursor="crosshair";return; }
  if (currentTool==="select") { selDragStart=null; isMovingSelection=false; moveDragStart=null; return; }
  if (isDrawing&&currentTool==="rect") { const [tx,ty]=screenToTile(e.clientX,e.clientY);pushUndo();if(placementMode==="stamp"&&selectedTiles.length>1&&currentTool!=="eraser"){const stamp=getStampTiles();const minX=Math.min(drawStartTX,tx),maxX=Math.max(drawStartTX,tx),minY=Math.min(drawStartTY,ty),maxY=Math.max(drawStartTY,ty);for(let y=minY;y<=maxY;y++)for(let x=minX;x<=maxX;x++){const s=stamp.find(s=>((x-minX)%Math.max(1,...stamp.map(s=>s.dx+1)))===s.dx&&((y-minY)%Math.max(1,...stamp.map(s=>s.dy+1)))===s.dy);if(s)setTileAt(x,y,s.idx,packXform());}}else if(placementMode==="random"&&selectedTiles.length>1&&currentTool!=="eraser"){const minX=Math.min(drawStartTX,tx),maxX=Math.max(drawStartTX,tx),minY=Math.min(drawStartTY,ty),maxY=Math.max(drawStartTY,ty);for(let y=minY;y<=maxY;y++)for(let x=minX;x<=maxX;x++)setTileAt(x,y,getRandomTile(),packXform());}else{fillRect(drawStartTX,drawStartTY,tx,ty,currentTool==="eraser"?255:getSelectedTile(),currentTool==="eraser"?0:packXform());}render(); }
  isDrawing=false;
});
wrap.addEventListener("dblclick", e => {
  e.preventDefault(); isPanning=true;panStartX=e.clientX;panStartY=e.clientY;panStartPanX=panX;panStartPanY=panY;wrap.style.cursor="grabbing";
});
wrap.addEventListener("wheel", e => {
  e.preventDefault(); const oldZoom=zoom;
  if (e.deltaY<0) zoom=Math.min(6,zoom*1.15); else zoom=Math.max(0.5,zoom/1.15);
  if (zoom!==oldZoom) { const rect=wrap.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;const s=zoom/oldZoom;panX=mx-s*(mx-panX);panY=my-s*(my-panY);render(); }
}, {passive:false});
wrap.addEventListener("contextmenu", e => e.preventDefault());

// Keyboard
document.addEventListener("keydown", e => {
  if (e.code==="Space") { spaceDown=true;e.preventDefault(); }
  if (e.ctrlKey||e.metaKey) {
    if (e.code==="KeyZ"&&!e.shiftKey) { e.preventDefault();undo(); }
    if (e.code==="KeyZ"&&e.shiftKey) { e.preventDefault();redo(); }
    if (e.code==="KeyS") { e.preventDefault();saveLevel(); }
    if (e.code==="KeyO") { e.preventDefault();document.getElementById("file-input").click(); }
    if (e.code==="KeyE") { e.preventDefault();exportMap(); }
    if (e.code==="KeyC") { e.preventDefault(); copySelection(); }
    if (e.code==="KeyX") { e.preventDefault(); copySelection(); clearSelectionArea(); }
    if (e.code==="KeyV") { e.preventDefault(); if (clipboard) { const px = selection ? selection.x : 0; const py = selection ? selection.y : 0; pasteClipboard(px, py); } }
    return;
  }
  if (e.code==="Digit1") { switchLayer(0); return; }
  if (e.code==="Digit2") { switchLayer(1); return; }
  if (e.code==="KeyB") setTool("pencil");
  if (e.code==="KeyT") setTool("rect");
  if (e.code==="KeyR") { curRotation = (curRotation + 1) % 4; updateXformStatus(); }
  if (e.code==="KeyH") { curHFlip = !curHFlip; updateXformStatus(); }
  if (e.code==="KeyV") { curVFlip = !curVFlip; updateXformStatus(); }
  if (e.code==="KeyG") setTool("fill");
  if (e.code==="KeyE") setTool("eraser");
  if (e.code==="KeyP") setTool("spawn");
  if (e.code==="KeyS"&&currentTool!=="select") setTool("select");
  if (e.code==="Escape") { clearSelection(); render(); }
  if ((e.code==="Delete"||e.code==="Backspace")&&selection) { e.preventDefault(); clearSelectionArea(); }
  if (e.code==="Tab") { e.preventDefault();toggleGrid(); }
  if (e.code==="KeyF") toggleFlagsOverlay();
  const num=parseInt(e.key);
  if (!isNaN(num)&&num>=0&&num<=7) { const mask=1<<num;const allSet=selectedTiles.every(ti=>(tileFlags[ti]&mask)!==0);for(const ti of selectedTiles){if(allSet)tileFlags[ti]&=~mask;else tileFlags[ti]|=mask;}updateFlagEditor();updatePaletteFlags();render(); }
});
document.addEventListener("keyup", e => { if (e.code==="Space") spaceDown=false; });

// Tools
function setTool(t) { if (currentTool==="select" && t!=="select") clearSelection(); currentTool=t; ["pencil","rect","fill","eraser","spawn","select"].forEach(n => document.getElementById("tool-"+n).classList.toggle("active",n===t)); render(); }
document.getElementById("tool-pencil").addEventListener("click", () => setTool("pencil"));
document.getElementById("tool-rect").addEventListener("click", () => setTool("rect"));
document.getElementById("tool-fill").addEventListener("click", () => setTool("fill"));
document.getElementById("tool-eraser").addEventListener("click", () => setTool("eraser"));
document.getElementById("tool-spawn").addEventListener("click", () => setTool("spawn"));
document.getElementById("tool-select").addEventListener("click", () => setTool("select"));
document.getElementById("mode-random").addEventListener("click", () => { if (selectedTiles.length > 1) setPlacementMode(placementMode === "random" ? "single" : "random"); });
document.getElementById("mode-stamp").addEventListener("click", () => { if (selectedTiles.length > 1) setPlacementMode(placementMode === "stamp" ? "single" : "stamp"); });

function toggleGrid() { showGrid=!showGrid;document.getElementById("btn-grid").textContent="Grid: "+(showGrid?"ON":"OFF");render(); }
function toggleFlagsOverlay() { showFlagsOverlay=!showFlagsOverlay;document.getElementById("btn-flags-overlay").textContent="Flags: "+(showFlagsOverlay?"ON":"OFF");render(); }
document.getElementById("btn-grid").addEventListener("click", toggleGrid);
document.getElementById("btn-flags-overlay").addEventListener("click", toggleFlagsOverlay);

// Resize
document.getElementById("btn-resize").addEventListener("click", () => {
  const nw=parseInt(document.getElementById("map-w").value)||128,nh=parseInt(document.getElementById("map-h").value)||32;
  if (nw===mapW&&nh===mapH) return; pushUndo();
  for (let i = 0; i < 2; i++) {
    const nm = [], nxf = [];
    const om = layers[i].map, ox = layers[i].xform;
    for (let y=0;y<nh;y++) { const r=new Uint8Array(nw).fill(255); const rx=new Uint8Array(nw); if (y<om.length) for (let x=0;x<Math.min(nw,om[0].length);x++) { r[x]=om[y][x]; rx[x]=ox[y][x]; } nm.push(r); nxf.push(rx); }
    layers[i] = {map: nm, xform: nxf};
  }
  mapW=nw;mapH=nh;
  map = layers[curLayer].map; mapXform = layers[curLayer].xform;
  render();
});

document.getElementById("btn-undo").addEventListener("click", undo);
document.getElementById("btn-redo").addEventListener("click", redo);
document.getElementById("btn-clear").addEventListener("click", () => {
  if (!confirm("Clear entire map?")) return;
  pushUndo(); for (let i=0;i<2;i++) { for (let y=0;y<mapH;y++) { layers[i].map[y].fill(255); layers[i].xform[y].fill(0); } } spawnX=-1;spawnY=-1; updateSpawnInfo(); render();
});

function setPalZoom(size) {
  palTileSize = Math.max(12, Math.min(80, size));
  const cols = activePalette === "bg" ? BG_TILE_COLS : 18;
  document.querySelector(".tile-grid").style.gridTemplateColumns = `repeat(${cols}, ${palTileSize}px)`;
  document.querySelectorAll(".tile-btn").forEach(b => { b.style.width = palTileSize+"px"; b.style.height = palTileSize+"px"; });
  document.querySelectorAll(".tile-spacer").forEach(s => { s.style.width = palTileSize+"px"; s.style.height = palTileSize+"px"; });
}
document.getElementById("pal-zoom-in").addEventListener("click", () => setPalZoom(palTileSize + 4));
document.getElementById("pal-zoom-out").addEventListener("click", () => setPalZoom(palTileSize - 4));

// JSON file download (for manual backup)
function saveMap() {
  const data = getLevelData();
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([JSON.stringify(data)],{type:"application/json"}));a.download="level.json";a.click();
}
function loadMap(file) {
  const reader=new FileReader();
  reader.onload=()=>{ try { const d=JSON.parse(reader.result); applyLevelData(d); } catch(e){alert("Failed: "+e.message);} };
  reader.readAsText(file);
}
document.getElementById("btn-load").addEventListener("click", () => document.getElementById("file-input").click());
document.getElementById("file-input").addEventListener("change", e => { if(e.target.files[0]) loadMap(e.target.files[0]); e.target.value=""; });

// Auto-save
function autoSave() { try { localStorage.setItem("pico8_level_autosave",JSON.stringify(getLevelData())); } catch(e){} }
function autoLoad() { try { const raw=localStorage.getItem("pico8_level_autosave"); if(!raw) return false; const d=JSON.parse(raw);
  if(!d.width) return false;
  mapW=d.width;mapH=d.height;
  if(d.layers) {
    if(d.version>=3||d.bgTiles) {
      for(let i=0;i<2;i++) layers[i]={map:d.layers[i].map.map(r=>new Uint8Array(r)),xform:d.layers[i].xform.map(r=>new Uint8Array(r))};
    } else {
      layers[0]=makeEmptyLayer();
      layers[1]={map:d.layers[1].map.map(r=>new Uint8Array(r)),xform:d.layers[1].xform.map(r=>new Uint8Array(r))};
    }
  } else {
    for(let i=0;i<2;i++) layers[i]=makeEmptyLayer();
    layers[1]={map:d.map.map(r=>new Uint8Array(r)),xform:d.mapXform?d.mapXform.map(r=>new Uint8Array(r)):layers[1].xform};
  }
  map=layers[curLayer].map;mapXform=layers[curLayer].xform;
  if(d.flags) for(let i=0;i<Math.min(d.flags.length,tileFlags.length);i++) tileFlags[i]=d.flags[i];
  if(d.spawnX!=null){spawnX=d.spawnX;spawnY=d.spawnY;}
  if(d.bandColors) for(let i=0;i<Math.min(d.bandColors.length,bandColors.length);i++) bandColors[i]=d.bandColors[i];
  if(d.parallax) for(let i=0;i<2;i++) layerParallax[i]=d.parallax[i]??layerParallax[i];
  document.querySelectorAll(".parallax-input").forEach(inp=>{inp.value=layerParallax[parseInt(inp.dataset.layer)];});
  document.getElementById("map-w").value=mapW;document.getElementById("map-h").value=mapH;return true;} catch(e){return false;} }
setInterval(autoSave, 10000);

// Export
function exportMap() {
  const bytes = compressMap();
  const hex = bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
  const pct = ((bytes.length/(mapW*mapH))*100).toFixed(1);
  const fits = bytes.length <= 4096 ? "fits in __map__" : "EXCEEDS 4096 byte __map__ limit!";
  document.getElementById("export-info").textContent = `Map: ${mapW}x${mapH} = ${mapW*mapH} cells | Compressed: ${bytes.length} bytes (${pct}%) | ${fits}`;
  document.getElementById("export-hex").value = hex;
  document.getElementById("export-modal").classList.add("show");
}
document.getElementById("export-copy").addEventListener("click",()=>{navigator.clipboard.writeText(document.getElementById("export-hex").value);document.getElementById("export-copy").textContent="Copied!";setTimeout(()=>document.getElementById("export-copy").textContent="Copy to Clipboard",1500);});
document.getElementById("export-close").addEventListener("click",()=>document.getElementById("export-modal").classList.remove("show"));

// â”€â”€ Level I/O (via local server, JSON) â”€â”€

function getLevelData() {
  return {
    version: 3,
    width: mapW,
    height: mapH,
    tiles: TILES.map(t => t.name),
    bgTiles: BG_TILES.map(t => t.name),
    flags: Array.from(tileFlags),
    layers: layers.map(L => ({
      map: L.map.map(r => Array.from(r)),
      xform: L.xform.map(r => Array.from(r))
    })),
    spawnX: spawnX,
    spawnY: spawnY,
    bandColors: Array.from(bandColors),
    parallax: Array.from(layerParallax)
  };
}

function applyLevelData(d) {
  pushUndo();
  mapW = d.width; mapH = d.height;
  if (d.layers) {
    if (d.version >= 3 || d.bgTiles) {
      // v3 format: BG layer uses BG tileset
      for (let i = 0; i < 2; i++) {
        layers[i] = {
          map: d.layers[i].map.map(r => new Uint8Array(r)),
          xform: d.layers[i].xform.map(r => new Uint8Array(r))
        };
      }
    } else {
      // v2: BG layer had main tileset indices â€” clear BG, keep Main
      layers[0] = makeEmptyLayer();
      layers[1] = {
        map: d.layers[1].map.map(r => new Uint8Array(r)),
        xform: d.layers[1].xform.map(r => new Uint8Array(r))
      };
    }
  } else {
    // v1 migration: put map into Main layer
    for (let i = 0; i < 2; i++) layers[i] = makeEmptyLayer();
    layers[1] = {
      map: d.map.map(r => new Uint8Array(r)),
      xform: d.mapXform ? d.mapXform.map(r => new Uint8Array(r)) : layers[1].xform
    };
  }
  map = layers[curLayer].map;
  mapXform = layers[curLayer].xform;
  if (d.flags) for (let i=0; i<Math.min(d.flags.length, tileFlags.length); i++) tileFlags[i] = d.flags[i];
  if (d.spawnX != null) { spawnX = d.spawnX; spawnY = d.spawnY; }
  if (d.bandColors) { for (let i=0; i<Math.min(d.bandColors.length, bandColors.length); i++) bandColors[i] = d.bandColors[i]; remapAllTiles(); }
  if (d.parallax) { for (let i=0; i<2; i++) layerParallax[i] = d.parallax[i] ?? layerParallax[i]; }
  document.querySelectorAll(".parallax-input").forEach(inp => { inp.value = layerParallax[parseInt(inp.dataset.layer)]; });
  document.getElementById("map-w").value = mapW;
  document.getElementById("map-h").value = mapH;
  updatePaletteFlags(); updateFlagEditor(); updateSpawnInfo(); render();
}

async function loadLevel() {
  try {
    const resp = await fetch("/level");
    if (!resp.ok) { document.getElementById("st-cart").textContent = "load failed"; return; }
    const d = await resp.json();
    if (!d.width) { document.getElementById("st-cart").textContent = "no level data"; return; }
    applyLevelData(d);
    document.getElementById("st-cart").textContent = "level_data.json loaded";
  } catch(e) { document.getElementById("st-cart").textContent = "server offline"; }
}

async function saveLevel() {
  try {
    const data = getLevelData();
    const resp = await fetch("/level", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(data) });
    if (!resp.ok) { alert("Failed to save: " + resp.statusText); return; }
    document.getElementById("st-cart").textContent = "saved";
    setTimeout(() => document.getElementById("st-cart").textContent = "level_data.json", 2000);
  } catch(e) { alert("Save failed: " + e.message); }
}

// Keep compressMap for export info display
function compressMap() {
  const bytes = [];
  const sx = spawnX>=0 ? spawnX : 0xFFFF;
  const sy = spawnY>=0 ? spawnY : 0xFFFF;
  bytes.push(mapW&0xff, (mapW>>8)&0xff, mapH&0xff, (mapH>>8)&0xff, sx&0xff, (sx>>8)&0xff, sy&0xff, (sy>>8)&0xff);
  for (let y=0; y<mapH; y++) {
    let x=0;
    while (x<mapW) {
      const ti = map[y][x];
      const spr = (ti===255) ? 0 : ti+1;
      const xf = mapXform[y] ? mapXform[y][x] : 0;
      let r=1;
      while (x+r<mapW && r<255) {
        const nti = map[y][x+r];
        const nspr = (nti===255) ? 0 : nti+1;
        const nxf = mapXform[y] ? mapXform[y][x+r] : 0;
        if (nspr !== spr || nxf !== xf) break;
        r++;
      }
      bytes.push(spr, xf, r);
      x += r;
    }
  }
  return bytes;
}

// Estimate __map__ memory usage (matches build.py format)
function estimateMapMemory() {
  const TRANS = 14;

  function getTilePixels(lumArr, ti) {
    const lums = lumArr[ti];
    if (!lums) return null;
    const pix = [];
    for (let p = 0; p < 256; p++) {
      if (lums[p].a < 128) { pix.push(TRANS); continue; }
      const band = lumToBand(lums[p].lum);
      pix.push(bandColors[band]);
    }
    return pix;
  }

  function rot90(pix) {
    let grid = [];
    for (let y=0; y<16; y++) grid.push(pix.slice(y*16, (y+1)*16));
    const ng = [];
    for (let x=0; x<16; x++) {
      const row = [];
      for (let y=15; y>=0; y--) row.push(grid[y][x]);
      ng.push(row);
    }
    return ng.flat();
  }

  function nibbleRLE(pix) {
    let size = 0, cur = pix[0], cnt = 1;
    for (let i=1; i<pix.length; i++) {
      if (pix[i] === cur && cnt < 16) { cnt++; }
      else { size += Math.ceil(cnt/16); cur = pix[i]; cnt = 1; }
    }
    size += Math.ceil(cnt/16);
    return size;
  }

  // Step 1: collect used tiles per layer (each layer has its own tileset)
  const needBase = [new Set(), new Set()], needRot90 = [new Set(), new Set()];
  for (let L=0; L<2; L++) {
    const lm = layers[L].map, lx = layers[L].xform;
    for (let y=0; y<mapH; y++) {
      for (let x=0; x<mapW; x++) {
        const ti = lm[y][x];
        if (ti === 255) continue;
        const rot = lx[y][x] & 3;
        if (rot === 0 || rot === 2) needBase[L].add(ti);
        else needRot90[L].add(ti);
      }
    }
  }

  // Step 2: build runtime tiles from both tilesets, dedup into shared pool
  const seenHashes = new Map();
  let numRT = 0, tileRLETotal = 0;
  const lumArrs = [bgTileLum, tileLum];
  for (let L=0; L<2; L++) {
    const allTiles = new Set([...needBase[L], ...needRot90[L]]);
    for (const ti of allTiles) {
      const base = getTilePixels(lumArrs[L], ti);
      if (!base) continue;
      if (needBase[L].has(ti)) {
        const hash = base.join(",");
        if (!seenHashes.has(hash)) {
          seenHashes.set(hash, numRT++);
          tileRLETotal += nibbleRLE(base);
        }
      }
      if (needRot90[L].has(ti)) {
        const r90 = rot90(base);
        const hash = r90.join(",");
        if (!seenHashes.has(hash)) {
          seenHashes.set(hash, numRT++);
          tileRLETotal += nibbleRLE(r90);
        }
      }
    }
  }

  // Step 3: encode each layer with best mode (matches build.py)
  // Build cell grids first (simplified: no full editor_to_cell, just use tile presence)
  function editorToCell(L, ti, xf) {
    if (ti === 255) return 0;
    // Simplified: just need non-zero for size estimation
    return ti + 1;  // any non-zero value works for RLE/pattern detection
  }
  function encodeRLESize(grid) {
    let sz = 0;
    for (let y=0; y<mapH; y++) {
      let x = 0;
      while (x < mapW) {
        let run = 1;
        while (x+run < mapW && run < 255 && grid[y][x+run] === grid[y][x]) run++;
        sz += 2; x += run;
      }
    }
    return sz;
  }
  function detectTiling(grid) {
    let minX=mapW, minY=mapH, maxX=-1, maxY=-1;
    for (let y=0; y<mapH; y++) for (let x=0; x<mapW; x++) {
      if (grid[y][x] !== 0) { minX=Math.min(minX,x); minY=Math.min(minY,y); maxX=Math.max(maxX,x); maxY=Math.max(maxY,y); }
    }
    if (maxX < 0) return null;
    const bw=maxX-minX+1, bh=maxY-minY+1;
    let best = null;
    for (let tw=1; tw<=bw; tw++) for (let th=1; th<=bh; th++) {
      const cost = 6 + tw*th;
      if (best && cost >= best) continue;
      let ok = true;
      for (let y=minY; ok && y<=maxY; y++) for (let x=minX; x<=maxX; x++) {
        if (grid[y][x] !== grid[minY+(y-minY)%th][minX+(x-minX)%tw]) { ok=false; break; }
      }
      if (ok) best = cost;
    }
    return best;
  }
  function packBitsSize(grid) {
    const flat = [];
    for (let y=0; y<mapH; y++) for (let x=0; x<mapW; x++) flat.push(grid[y][x]);
    let sz=0, i=0, n=flat.length;
    while (i < n) {
      let run=1;
      while (i+run < n && run < 130 && flat[i+run] === flat[i]) run++;
      if (run >= 3) { sz += 2; i += run; }
      else {
        let litLen = 0, li = i;
        while (i < n && litLen < 128) {
          let r=1; while (i+r < n && r < 130 && flat[i+r] === flat[i]) r++;
          if (r >= 3) break;
          litLen++; i++;
        }
        if (litLen > 0) sz += 1 + litLen;
      }
    }
    return sz;
  }
  let mapDataSize = 0;
  for (let L=0; L<2; L++) {
    const lm = layers[L].map, lx = layers[L].xform;
    const grid = [];
    for (let y=0; y<mapH; y++) { const row = []; for (let x=0; x<mapW; x++) row.push(editorToCell(L, lm[y][x], lx[y][x])); grid.push(row); }
    const rle = encodeRLESize(grid);
    let best = rle;
    const tiling = detectTiling(grid);
    if (tiling !== null && tiling < best) best = tiling;
    const pb = packBitsSize(grid);
    if (pb < best) best = pb;
    mapDataSize += best;
  }

  const header = 12 + 2; // +2 for layer mode bytes
  const tileIndex = numRT * 2;
  const total = header + tileIndex + tileRLETotal + mapDataSize;
  return { total, numRT, tileRLETotal, tileIndex, mapRLESize: mapDataSize, header };
}

function updateMemEstimate() {
  const m = estimateMapMemory();
  const pct = (m.total / 4096 * 100).toFixed(0);
  const el = document.getElementById("st-mem");
  el.textContent = `__map__: ${m.total}/4096 (${pct}%) [${m.numRT} tiles]`;
  el.style.color = m.total > 4096 ? "#f44" : m.total > 3072 ? "#fa0" : "#7e7";
}

function decompressMap(bytes) {
  const w = bytes[0] | (bytes[1]<<8);
  const h = bytes[2] | (bytes[3]<<8);
  if (w<1 || w>4096 || h<1 || h>4096) return null;
  const sx = bytes[4] | (bytes[5]<<8);
  const sy = bytes[6] | (bytes[7]<<8);
  const m = [], mxf = [];
  let ptr=8, y=0, x=0;
  let row = new Uint8Array(w).fill(255);
  let xfrow = new Uint8Array(w);
  while (ptr+2 < bytes.length && y < h) {
    const spr = bytes[ptr], xf = bytes[ptr+1], run = bytes[ptr+2];
    ptr += 3;
    const ti = (spr===0) ? 255 : spr-1;
    for (let i=0; i<run && y<h; i++) {
      row[x] = ti; xfrow[x] = xf;
      x++;
      if (x >= w) { m.push(row); mxf.push(xfrow); y++; x=0; row = new Uint8Array(w).fill(255); xfrow = new Uint8Array(w); }
    }
  }
  while (m.length < h) { m.push(new Uint8Array(w).fill(255)); mxf.push(new Uint8Array(w)); }
  return { width:w, height:h, map:m, mapXform:mxf, spawnX: sx===0xFFFF?-1:sx, spawnY: sy===0xFFFF?-1:sy };
}

document.getElementById("btn-save").addEventListener("click", saveLevel);
document.querySelectorAll(".layer-btn").forEach(b => {
  b.addEventListener("click", () => switchLayer(parseInt(b.dataset.layer)));
});
document.querySelectorAll(".layer-eye").forEach(b => {
  b.addEventListener("click", () => {
    const L = parseInt(b.dataset.layer);
    layerVisible[L] = !layerVisible[L];
    b.classList.toggle("hidden", !layerVisible[L]);
    render();
  });
});
document.querySelectorAll(".parallax-input").forEach(inp => {
  inp.addEventListener("change", () => {
    layerParallax[parseInt(inp.dataset.layer)] = parseFloat(inp.value) || 1;
  });
});

document.querySelectorAll(".pal-tab").forEach(b => {
  b.addEventListener("click", () => {
    const tab = b.dataset.tab;
    switchPaletteTab(tab);
    // Also switch to the matching layer
    switchLayer(tab === "bg" ? 0 : 1);
  });
});

// Boot
loadTileImages(async () => {
  extractTileLuminance();
  remapAllTiles();
  if (!autoLoad()) initMap();
  buildPalette();
  buildBandEditor();
  buildFlagButtons();
  updateFlagEditor();
  updateSpawnInfo();
  render();
  await loadLevel();
});
</script>
<div id="toast"></div>
</body>
</html>